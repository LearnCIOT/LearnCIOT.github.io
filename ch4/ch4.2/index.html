<!DOCTYPE html>
<html lang="zh-tw" class="js csstransforms3d">
  <head>

<meta property="og:title" content="4.2. 時間序列資料預測"/>
<meta property="og:description" content="我們使用民生公共物聯網資料平台的感測資料，套用現有的 Python 資料科學套件 (例如 scikit-learn、Kats 等)，用動手實作的方式，比較各種套件所內建的不同資料預測模型的使用方法與預測結果，用製圖的方式進行資料呈現，並且探討不同的資料集與不同時間解析度的資料預測，在真實場域所代表的意義，以及可能衍生的應用。"/>
<meta property="og:image" content="https://learnciot.github.io/images/thumbnail.jpg"/>
<meta property="og:url" content="/ch4/ch4.2/"/>
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="627" />
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.104.3">
    <meta name="generator" content="Relearn 5.3.3+tip">
    <meta name="description" content="我們使用民生公共物聯網資料平台的感測資料，套用現有的 Python 資料科學套件 (例如 scikit-learn、Kats 等)，用動手實作的方式，比較各種套件所內建的不同資料預測模型的使用方法與預測結果，用製圖的方式進行資料呈現，並且探討不同的資料集與不同時間解析度的資料預測，在真實場域所代表的意義，以及可能衍生的應用。">
    <meta name="author" content="Ling-Jyh Chen">
    <title>4.2. 時間序列資料預測 :: Tutorial for CIoT Open Data Applications</title>
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="/css/fontawesome-all.min.css?1701306709" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/fontawesome-all.min.css?1701306709" rel="stylesheet"></noscript>
    <link href="/css/featherlight.min.css?1701306709" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/featherlight.min.css?1701306709" rel="stylesheet"></noscript>
    <link href="/css/auto-complete.css?1701306709" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/auto-complete.css?1701306709" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar.min.css?1701306709" rel="stylesheet">
    <link href="/css/nucleus.css?1701306709" rel="stylesheet">
    <link href="/css/fonts.css?1701306709" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/fonts.css?1701306709" rel="stylesheet"></noscript>
    <link href="/css/theme.css?1701306709" rel="stylesheet">
    <link href="/css/theme-relearn-light.css?1701306709" rel="stylesheet" id="variant-style">
    <link href="/css/ie.css?1701306709" rel="stylesheet">
    <link href="/css/variant.css?1701306709" rel="stylesheet">
    <link href="/css/print.css?1701306709" rel="stylesheet" media="print">
    <script src="/js/variant.js?1701306709"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      var index_url="/index.json";
      var root_url="/";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = '複製到剪貼板';
      window.T_Copied_to_clipboard = '複製到剪貼簿！';
      window.T_Copy_link_to_clipboard = '將連結複製到剪貼簿';
      window.T_Link_copied_to_clipboard = '連結複製到剪貼簿！';
      // some further base stuff
      var baseUriFull='https:\/\/LearnCIOT.github.io/';
      window.variants && variants.init( [ 'relearn-light' ] );
    </script>
    <script src="/js/jquery.min.js?1701306709" defer></script>
<meta property="fb:app_id" content="601826851395774" />
  </head>
  <body class="default-animation" data-url="/ch4/ch4.2/">




<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v14.0" nonce="hWjBXHAv"></script>

    <div id="body" class="default-animation">
      <div id="sidebar-overlay"></div>
      <div id="toc-overlay"></div>
      <nav id="topbar" class="highlightable">
        <div>
          <div class="navigation">
             <a class="nav nav-next" href="/ch4/ch4.3/" title="4.3. 時間序列屬性分群"><i class="fas fa-chevron-right fa-fw"></i></a>
          </div>
          <div class="navigation">
             <a class="nav nav-prev" href="/ch4/ch4.1/" title="4.1. 時間序列資料處理"><i class="fas fa-chevron-left fa-fw"></i></a>
          </div>
          <div id="top-github-link">
            <a class="github-link" title='編輯網頁' href="https://github.com/LearnCIOT/LearnCIOT.github.io/tree/main/content/ch4/ch4.2/index.zh-tw.md" target="blank">
              <i class="fas fa-pen fa-fw"></i>
            </a>
          </div>
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" title='導航'><i class="fas fa-bars fa-fw"></i></a>
            </span>
            <span id="toc-menu" title='目錄'><i class="fas fa-list-alt fa-fw"></i></span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <meta itemprop="itemListOrder" content="Descending" />
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="3" /><a itemprop="item" href="/"><span itemprop="name">民生公共物聯網資料應用</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="2" /><a itemprop="item" href="/ch4/"><span itemprop="name">4. 時間維度資料分析</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="1" /><a itemprop="item" href="/ch4/ch4.2/" aria-disabled="true"><span itemprop="name">4.2. 時間序列資料預測</span></a></li>
            </ol>
          </div>
          <div class="default-animation progress">
            <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#章節目標">章節目標</a></li>
    <li><a href="#套件安裝與引入">套件安裝與引入</a></li>
    <li><a href="#讀取資料">讀取資料</a>
      <ul>
        <li><a href="#空品資料">空品資料</a></li>
        <li><a href="#水位資料">水位資料</a></li>
        <li><a href="#氣象資料">氣象資料</a></li>
      </ul>
    </li>
    <li><a href="#資料預處理-preprocess">資料預處理 (Preprocess)</a></li>
    <li><a href="#平穩性-stationary-檢查">平穩性 (Stationary) 檢查</a></li>
    <li><a href="#資料預測data-forecast">資料預測(Data forecast)</a>
      <ul>
        <li><a href="#arima">ARIMA</a></li>
        <li><a href="#sarimax">SARIMAX</a></li>
        <li><a href="#auto_arima">auto_arima</a></li>
        <li><a href="#prophet">Prophet</a></li>
        <li><a href="#lstm">LSTM</a></li>
        <li><a href="#holt-winter">Holt-Winter</a></li>
        <li><a href="#綜合比較">綜合比較</a></li>
      </ul>
    </li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav>
            </div>
          </div>
        </div>
      </nav>

      <main id="body-inner" class="highlightable ">
        <div class="flex-block-wrapper">
          <div id="head-tags"><div class="tags">
  <a class="level-link" href="/levels/intermediate">
  <b>
	&starf;&starf;&starf;&star;&star;
  </b>
  </a>
  <a class="tag-link" href="/tags/python">Python</a>
  <a class="tag-link" href="/tags/%E6%B0%B4">水</a>
  <a class="tag-link" href="/tags/%E7%A9%BA">空</a>
</div>

          </div>


  
  
  

  <section class="social-share">
    <ul class="share-icons">
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?hashtags=codingnconcepts&amp;url=https%3a%2f%2fLearnCIOT.github.io%2fch4%2fch4.2%2f&amp;text=4.2.%20%e6%99%82%e9%96%93%e5%ba%8f%e5%88%97%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac" target="_blank" rel="noopener" aria-label="Share on Twitter" class="share-btn twitter">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="26px" viewBox="0 0 31 26" version="1.1">
<g id="surface1">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(11.372549%,60.784314%,94.117647%);fill-opacity:1;" d="M 27.742188 6.535156 C 27.761719 6.8125 27.761719 7.089844 27.761719 7.371094 C 27.761719 15.875 21.414062 25.683594 9.800781 25.683594 L 9.800781 25.675781 C 6.371094 25.683594 3.011719 24.679688 0.125 22.792969 C 0.625 22.851562 1.125 22.882812 1.628906 22.886719 C 4.46875 22.886719 7.230469 21.914062 9.46875 20.125 C 6.765625 20.070312 4.398438 18.277344 3.570312 15.65625 C 4.515625 15.839844 5.492188 15.800781 6.421875 15.542969 C 3.476562 14.9375 1.355469 12.300781 1.355469 9.234375 L 1.355469 9.152344 C 2.234375 9.652344 3.214844 9.929688 4.222656 9.960938 C 1.449219 8.070312 0.59375 4.304688 2.265625 1.363281 C 5.472656 5.386719 10.203125 7.832031 15.277344 8.089844 C 14.769531 5.855469 15.464844 3.511719 17.105469 1.941406 C 19.644531 -0.496094 23.644531 -0.371094 26.035156 2.21875 C 27.449219 1.933594 28.804688 1.40625 30.042969 0.65625 C 29.574219 2.144531 28.585938 3.410156 27.269531 4.214844 C 28.519531 4.066406 29.742188 3.722656 30.894531 3.203125 C 30.046875 4.496094 28.980469 5.625 27.742188 6.535156 Z M 27.742188 6.535156 "/>
</g>
</svg>

          <p>Twitter</p>
          </a>
      </li>
      

      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fLearnCIOT.github.io%2fch4%2fch4.2%2f" target="_blank" rel="noopener" aria-label="Share on Facebook" class="share-btn facebook">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="0 0 32 32" version="1.1">
<defs>
<linearGradient id="linear0" gradientUnits="userSpaceOnUse" x1="-277.375" y1="406.6018" x2="-277.375" y2="407.5726" gradientTransform="matrix(32,0,0,-31.82224,8892.0008,12969.8672)">
<stop offset="0" style="stop-color:rgb(0%,38.431373%,87.843137%);stop-opacity:1;"/>
<stop offset="1" style="stop-color:rgb(9.803922%,68.627451%,100%);stop-opacity:1;"/>
</linearGradient>
</defs>
<g id="surface1">
<path style=" stroke:none;fill-rule:nonzero;fill:url(#linear0);" d="M 13.359375 31.839844 C 5.761719 30.480469 0 23.921875 0 16 C 0 7.199219 7.199219 0 16 0 C 24.800781 0 32 7.199219 32 16 C 32 23.921875 26.238281 30.480469 18.640625 31.839844 L 17.761719 31.121094 L 14.238281 31.121094 Z M 13.359375 31.839844 "/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 22.238281 20.480469 L 22.960938 16 L 18.71875 16 L 18.71875 12.878906 C 18.71875 11.601562 19.199219 10.640625 21.121094 10.640625 L 23.199219 10.640625 L 23.199219 6.558594 C 22.078125 6.398438 20.800781 6.238281 19.679688 6.238281 C 16 6.238281 13.441406 8.480469 13.441406 12.480469 L 13.441406 16 L 9.441406 16 L 9.441406 20.480469 L 13.441406 20.480469 L 13.441406 31.761719 C 14.320312 31.921875 15.199219 32 16.078125 32 C 16.960938 32 17.839844 31.921875 18.71875 31.761719 L 18.71875 20.480469 Z M 22.238281 20.480469 "/>
</g>
</svg>

          <p>Facebook</p>
          </a>
      </li>
      

      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fLearnCIOT.github.io%2fch4%2fch4.2%2f&amp;source=https%3a%2f%2fLearnCIOT.github.io%2fch4%2fch4.2%2f&amp;title=4.2.%20%e6%99%82%e9%96%93%e5%ba%8f%e5%88%97%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac&amp;summary=4.2.%20%e6%99%82%e9%96%93%e5%ba%8f%e5%88%97%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac" target="_blank" rel="noopener" aria-label="Share on LinkedIn" class="share-btn linkedin">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="0 0 32 32" version="1.1">
<g id="surface1">
<path style=" stroke:none;fill-rule:evenodd;fill:rgb(0%,49.411765%,73.333333%);fill-opacity:1;" d="M 16 32 C 24.835938 32 32 24.835938 32 16 C 32 7.164062 24.835938 0 16 0 C 7.164062 0 0 7.164062 0 16 C 0 24.835938 7.164062 32 16 32 Z M 16 32 "/>
<path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 26.222656 25.332031 L 22.203125 25.332031 L 22.203125 18.488281 C 22.203125 16.613281 21.492188 15.566406 20.007812 15.566406 C 18.390625 15.566406 17.546875 16.65625 17.546875 18.488281 L 17.546875 25.332031 L 13.675781 25.332031 L 13.675781 12.296875 L 17.546875 12.296875 L 17.546875 14.050781 C 17.546875 14.050781 18.710938 11.898438 21.476562 11.898438 C 24.242188 11.898438 26.222656 13.585938 26.222656 17.078125 Z M 9.054688 10.589844 C 7.734375 10.589844 6.667969 9.511719 6.667969 8.183594 C 6.667969 6.855469 7.734375 5.777344 9.054688 5.777344 C 10.375 5.777344 11.441406 6.855469 11.441406 8.183594 C 11.441406 9.511719 10.375 10.589844 9.054688 10.589844 Z M 7.054688 25.332031 L 11.09375 25.332031 L 11.09375 12.296875 L 7.054688 12.296875 Z M 7.054688 25.332031 "/>
</g>
</svg>

            <p>LinkedIn</p>
          </a>
      </li>
      

      
      
      <li>
        <a href="whatsapp://send?text=4.2.%20%e6%99%82%e9%96%93%e5%ba%8f%e5%88%97%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac%2c%20by%20Tutorial%20for%20CIoT%20Open%20Data%20Applications%0a%e6%88%91%e5%80%91%e4%bd%bf%e7%94%a8%e6%b0%91%e7%94%9f%e5%85%ac%e5%85%b1%e7%89%a9%e8%81%af%e7%b6%b2%e8%b3%87%e6%96%99%e5%b9%b3%e5%8f%b0%e7%9a%84%e6%84%9f%e6%b8%ac%e8%b3%87%e6%96%99%ef%bc%8c%e5%a5%97%e7%94%a8%e7%8f%be%e6%9c%89%e7%9a%84%20Python%20%e8%b3%87%e6%96%99%e7%a7%91%e5%ad%b8%e5%a5%97%e4%bb%b6%20%28%e4%be%8b%e5%a6%82%20scikit-learn%e3%80%81Kats%20%e7%ad%89%29%ef%bc%8c%e7%94%a8%e5%8b%95%e6%89%8b%e5%af%a6%e4%bd%9c%e7%9a%84%e6%96%b9%e5%bc%8f%ef%bc%8c%e6%af%94%e8%bc%83%e5%90%84%e7%a8%ae%e5%a5%97%e4%bb%b6%e6%89%80%e5%85%a7%e5%bb%ba%e7%9a%84%e4%b8%8d%e5%90%8c%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac%e6%a8%a1%e5%9e%8b%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95%e8%88%87%e9%a0%90%e6%b8%ac%e7%b5%90%e6%9e%9c%ef%bc%8c%e7%94%a8%e8%a3%bd%e5%9c%96%e7%9a%84%e6%96%b9%e5%bc%8f%e9%80%b2%e8%a1%8c%e8%b3%87%e6%96%99%e5%91%88%e7%8f%be%ef%bc%8c%e4%b8%a6%e4%b8%94%e6%8e%a2%e8%a8%8e%e4%b8%8d%e5%90%8c%e7%9a%84%e8%b3%87%e6%96%99%e9%9b%86%e8%88%87%e4%b8%8d%e5%90%8c%e6%99%82%e9%96%93%e8%a7%a3%e6%9e%90%e5%ba%a6%e7%9a%84%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac%ef%bc%8c%e5%9c%a8%e7%9c%9f%e5%af%a6%e5%a0%b4%e5%9f%9f%e6%89%80%e4%bb%a3%e8%a1%a8%e7%9a%84%e6%84%8f%e7%be%a9%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%8f%af%e8%83%bd%e8%a1%8d%e7%94%9f%e7%9a%84%e6%87%89%e7%94%a8%e3%80%82%0a%0ahttps%3a%2f%2fLearnCIOT.github.io%2fch4%2fch4.2%2f%0a" target="_blank" class="share-btn whatsapp">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="0 0 32 32" version="1.1">
<defs>
<image id="image5" width="588" height="590" xlink:href="data:image/png;base64,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"/>
</defs>
<g id="surface2">
<use xlink:href="#image5" transform="matrix(0.054145,0,0,0.054145,0.054145,0)"/>
<path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 24.355469 7.726562 C 22.222656 5.585938 19.378906 4.410156 16.355469 4.40625 C 10.117188 4.40625 5.042969 9.484375 5.042969 15.71875 C 5.039062 17.714844 5.5625 19.660156 6.550781 21.375 L 4.945312 27.238281 L 10.945312 25.664062 C 12.597656 26.566406 14.457031 27.039062 16.351562 27.042969 L 16.355469 27.042969 C 22.589844 27.042969 27.664062 21.964844 27.667969 15.730469 C 27.667969 12.707031 26.492188 9.863281 24.355469 7.726562 Z M 16.355469 25.132812 L 16.351562 25.132812 C 14.664062 25.128906 13.007812 24.675781 11.566406 23.820312 L 11.222656 23.617188 L 7.664062 24.550781 L 8.613281 21.082031 L 8.390625 20.722656 C 7.449219 19.226562 6.949219 17.496094 6.953125 15.71875 C 6.953125 10.535156 11.171875 6.320312 16.359375 6.320312 C 18.871094 6.320312 21.230469 7.296875 23.003906 9.074219 C 24.78125 10.851562 25.757812 13.214844 25.757812 15.726562 C 25.753906 20.914062 21.535156 25.132812 16.355469 25.132812 Z M 21.511719 18.089844 C 21.230469 17.945312 19.839844 17.261719 19.582031 17.167969 C 19.320312 17.074219 19.132812 17.027344 18.945312 17.3125 C 18.757812 17.59375 18.214844 18.230469 18.050781 18.417969 C 17.882812 18.609375 17.71875 18.632812 17.4375 18.488281 C 17.152344 18.347656 16.242188 18.050781 15.164062 17.085938 C 14.324219 16.335938 13.757812 15.410156 13.589844 15.128906 C 13.425781 14.84375 13.574219 14.691406 13.714844 14.550781 C 13.84375 14.425781 13.996094 14.222656 14.140625 14.054688 C 14.28125 13.890625 14.328125 13.773438 14.421875 13.585938 C 14.515625 13.394531 14.46875 13.230469 14.398438 13.089844 C 14.328125 12.949219 13.761719 11.554688 13.527344 10.992188 C 13.296875 10.441406 13.066406 10.515625 12.890625 10.503906 C 12.726562 10.496094 12.539062 10.496094 12.347656 10.496094 C 12.160156 10.496094 11.855469 10.566406 11.59375 10.847656 C 11.335938 11.132812 10.605469 11.816406 10.605469 13.207031 C 10.605469 14.597656 11.617188 15.941406 11.761719 16.132812 C 11.902344 16.320312 13.753906 19.175781 16.589844 20.398438 C 17.261719 20.691406 17.789062 20.863281 18.199219 20.996094 C 18.878906 21.210938 19.492188 21.179688 19.980469 21.105469 C 20.523438 21.027344 21.652344 20.421875 21.890625 19.761719 C 22.125 19.101562 22.125 18.535156 22.054688 18.417969 C 21.984375 18.300781 21.792969 18.230469 21.511719 18.089844 Z M 21.511719 18.089844 "/>
</g>
</svg>

          <p>Email</p>
        </a>
      </li>
      

      
      
      <li>
        <a href="mailto:?subject=Tutorial%20for%20CIoT%20Open%20Data%20Applications - 4.2.%20%e6%99%82%e9%96%93%e5%ba%8f%e5%88%97%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac.&amp;body=4.2.%20%e6%99%82%e9%96%93%e5%ba%8f%e5%88%97%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac%2c%20by%20Tutorial%20for%20CIoT%20Open%20Data%20Applications%0a%e6%88%91%e5%80%91%e4%bd%bf%e7%94%a8%e6%b0%91%e7%94%9f%e5%85%ac%e5%85%b1%e7%89%a9%e8%81%af%e7%b6%b2%e8%b3%87%e6%96%99%e5%b9%b3%e5%8f%b0%e7%9a%84%e6%84%9f%e6%b8%ac%e8%b3%87%e6%96%99%ef%bc%8c%e5%a5%97%e7%94%a8%e7%8f%be%e6%9c%89%e7%9a%84%20Python%20%e8%b3%87%e6%96%99%e7%a7%91%e5%ad%b8%e5%a5%97%e4%bb%b6%20%28%e4%be%8b%e5%a6%82%20scikit-learn%e3%80%81Kats%20%e7%ad%89%29%ef%bc%8c%e7%94%a8%e5%8b%95%e6%89%8b%e5%af%a6%e4%bd%9c%e7%9a%84%e6%96%b9%e5%bc%8f%ef%bc%8c%e6%af%94%e8%bc%83%e5%90%84%e7%a8%ae%e5%a5%97%e4%bb%b6%e6%89%80%e5%85%a7%e5%bb%ba%e7%9a%84%e4%b8%8d%e5%90%8c%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac%e6%a8%a1%e5%9e%8b%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95%e8%88%87%e9%a0%90%e6%b8%ac%e7%b5%90%e6%9e%9c%ef%bc%8c%e7%94%a8%e8%a3%bd%e5%9c%96%e7%9a%84%e6%96%b9%e5%bc%8f%e9%80%b2%e8%a1%8c%e8%b3%87%e6%96%99%e5%91%88%e7%8f%be%ef%bc%8c%e4%b8%a6%e4%b8%94%e6%8e%a2%e8%a8%8e%e4%b8%8d%e5%90%8c%e7%9a%84%e8%b3%87%e6%96%99%e9%9b%86%e8%88%87%e4%b8%8d%e5%90%8c%e6%99%82%e9%96%93%e8%a7%a3%e6%9e%90%e5%ba%a6%e7%9a%84%e8%b3%87%e6%96%99%e9%a0%90%e6%b8%ac%ef%bc%8c%e5%9c%a8%e7%9c%9f%e5%af%a6%e5%a0%b4%e5%9f%9f%e6%89%80%e4%bb%a3%e8%a1%a8%e7%9a%84%e6%84%8f%e7%be%a9%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%8f%af%e8%83%bd%e8%a1%8d%e7%94%9f%e7%9a%84%e6%87%89%e7%94%a8%e3%80%82%0a%0ahttps%3a%2f%2fLearnCIOT.github.io%2fch4%2fch4.2%2f%0a" target="_blank" class="share-btn email">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="0 0 32 32" version="1.1">
<defs>
<filter id="alpha" filterUnits="objectBoundingBox" x="0%" y="0%" width="100%" height="100%">
  <feColorMatrix type="matrix" in="SourceGraphic" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 1 0"/>
</filter>
<mask id="mask0">
  <g filter="url(#alpha)">
<rect x="0" y="0" width="32" height="32" style="fill:rgb(0%,0%,0%);fill-opacity:0.2;stroke:none;"/>
  </g>
</mask>
<clipPath id="clip1">
  <rect x="0" y="0" width="32" height="32"/>
</clipPath>
<g id="surface5" clip-path="url(#clip1)">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(13.72549%,12.156863%,12.54902%);fill-opacity:1;" d="M 26 22 C 26 23.101562 25.101562 24 24 24 L 8 24 C 6.898438 24 6 23.101562 6 22 L 6 12 C 6 10.898438 6.898438 10 8 10 L 24 10 C 25.101562 10 26 10.898438 26 12 Z M 26 22 "/>
</g>
<mask id="mask1">
  <g filter="url(#alpha)">
<rect x="0" y="0" width="32" height="32" style="fill:rgb(0%,0%,0%);fill-opacity:0.2;stroke:none;"/>
  </g>
</mask>
<clipPath id="clip2">
  <rect x="0" y="0" width="32" height="32"/>
</clipPath>
<g id="surface8" clip-path="url(#clip2)">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(13.72549%,12.156863%,12.54902%);fill-opacity:1;" d="M 17.75 15.101562 C 16.800781 14.050781 15.199219 14.050781 14.25 15.101562 L 6.5 21.601562 C 6.398438 21.699219 6.351562 21.800781 6.25 21.898438 C 6.601562 22.550781 7.25 23 7.949219 23 L 23.949219 23 C 24.699219 23 25.300781 22.550781 25.648438 21.898438 C 25.601562 21.800781 25.5 21.699219 25.398438 21.601562 Z M 17.75 15.101562 "/>
</g>
<mask id="mask2">
  <g filter="url(#alpha)">
<rect x="0" y="0" width="32" height="32" style="fill:rgb(0%,0%,0%);fill-opacity:0.2;stroke:none;"/>
  </g>
</mask>
<clipPath id="clip3">
  <rect x="0" y="0" width="32" height="32"/>
</clipPath>
<g id="surface11" clip-path="url(#clip3)">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(13.72549%,12.156863%,12.54902%);fill-opacity:1;" d="M 6.300781 10.101562 C 6.648438 9.449219 7.300781 9 8 9 L 24 9 C 24.75 9 25.351562 9.449219 25.699219 10.101562 C 25.648438 10.199219 25.550781 10.300781 25.449219 10.398438 L 17.75 16.898438 C 16.800781 17.949219 15.199219 17.949219 14.25 16.898438 Z M 6.300781 10.101562 "/>
</g>
</defs>
<g id="surface1">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(46.666667%,70.196078%,83.137255%);fill-opacity:1;" d="M 32 16 C 32 24.835938 24.835938 32 16 32 C 7.164062 32 0 24.835938 0 16 C 0 7.164062 7.164062 0 16 0 C 24.835938 0 32 7.164062 32 16 Z M 32 16 "/>
<use xlink:href="#surface5" mask="url(#mask0)"/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(87.843137%,87.843137%,81.960784%);fill-opacity:1;" d="M 26 21 C 26 22.101562 25.101562 23 24 23 L 8 23 C 6.898438 23 6 22.101562 6 21 L 6 11 C 6 9.898438 6.898438 9 8 9 L 24 9 C 25.101562 9 26 9.898438 26 11 Z M 26 21 "/>
<use xlink:href="#surface8" mask="url(#mask1)"/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(87.843137%,87.843137%,81.960784%);fill-opacity:1;" d="M 17.75 16 C 16.800781 15.050781 15.199219 15.050781 14.25 16 L 6.5 21.75 C 6.398438 21.851562 6.351562 21.898438 6.25 22 C 6.601562 22.601562 7.25 22.949219 7.949219 22.949219 L 23.949219 22.949219 C 24.699219 22.949219 25.300781 22.550781 25.648438 22 C 25.601562 21.898438 25.5 21.851562 25.398438 21.75 Z M 17.75 16 "/>
<use xlink:href="#surface11" mask="url(#mask2)"/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 14.25 16 C 15.199219 16.949219 16.800781 16.949219 17.75 16 L 25.5 10.25 C 25.601562 10.148438 25.648438 10.101562 25.75 10 C 25.398438 9.398438 24.75 9.050781 24.050781 9.050781 L 8 9.050781 C 7.25 9.050781 6.648438 9.449219 6.300781 10 C 6.351562 10.101562 6.449219 10.148438 6.550781 10.25 Z M 14.25 16 "/>
</g>
</svg>

          <p>Email</p>
        </a>
      </li>
    </ul>
  </section>
  



<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZCH7EJS8LE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-ZCH7EJS8LE', { 'anonymize_ip': false });
}
</script>



          <article class="default">
<h1>4.2. 時間序列資料預測</h1>

<p><a href="https://colab.research.google.com/drive/1lAqt91m88srcPWLSabbN9Tdbxw1y2I2n?usp=sharing"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<div>
    <h2>Table Of Contents</h2>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#章節目標">章節目標</a></li>
    <li><a href="#套件安裝與引入">套件安裝與引入</a></li>
    <li><a href="#讀取資料">讀取資料</a>
      <ul>
        <li><a href="#空品資料">空品資料</a></li>
        <li><a href="#水位資料">水位資料</a></li>
        <li><a href="#氣象資料">氣象資料</a></li>
      </ul>
    </li>
    <li><a href="#資料預處理-preprocess">資料預處理 (Preprocess)</a></li>
    <li><a href="#平穩性-stationary-檢查">平穩性 (Stationary) 檢查</a></li>
    <li><a href="#資料預測data-forecast">資料預測(Data forecast)</a>
      <ul>
        <li><a href="#arima">ARIMA</a></li>
        <li><a href="#sarimax">SARIMAX</a></li>
        <li><a href="#auto_arima">auto_arima</a></li>
        <li><a href="#prophet">Prophet</a></li>
        <li><a href="#lstm">LSTM</a></li>
        <li><a href="#holt-winter">Holt-Winter</a></li>
        <li><a href="#綜合比較">綜合比較</a></li>
      </ul>
    </li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav>
</div>

<p>前一章節介紹了各種處理時序資料的方法，有視覺化呈現資料、時序資料分解&hellip;&hellip;等，經過處理後的資料可以讓我們更進一步的運用，擁有過去的資料後，會想要預知未來，因此本章節將會判斷時序資料的特性以及使用多種預測模型找出資料的的模式，藉此預測未來。</p>
<h2 id="章節目標">章節目標</h2>
<ul>
<li>時序資料特性的判斷：平穩性</li>
<li>學習各種預測模型並進行比較</li>
<li>使用時序資料進行訓練與預測</li>
</ul>
<h2 id="套件安裝與引入">套件安裝與引入</h2>
<p>在本章節中，我們將會使用到 pandas, matplotlib, numpy, statsmodels, warnings 等套件，這些套件由於在我們使用的開發平台 Colab 上皆已預先安裝好，因此不需要再另行安裝。然而，我們還會另外使用兩個 Colab 並未預先安裝好的套件：kats 和 pmdarima，需使用下列的方式自行安裝：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 升級 pip，確保可以順利安裝後續的函式模組</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install <span style="color:#f92672">--</span>upgrade pip 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安裝特定版本的 kats、ax-platform 和 statsmodels 函式模組</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kats: Facebook 提供的時間序列工具箱</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ax-platform: 用於自適應實驗設計和優化的平台</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># statsmodels: 提供統計模型和擬合的函式模組</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install kats<span style="color:#f92672">==</span><span style="color:#ae81ff">0.1</span> ax<span style="color:#f92672">-</span>platform<span style="color:#f92672">==</span><span style="color:#ae81ff">0.2.3</span> statsmodels<span style="color:#f92672">==</span><span style="color:#ae81ff">0.12.2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安裝 pmdarima 函式模組，它提供自動選擇 ARIMA 模型的功能，適用於時間序列分析</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install pmdarima
</span></span></code></pre></div><p>待安裝完畢後，即可使用下列的語法先行引入相關的套件，完成本章節的準備工作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> warnings <span style="color:#75715e"># 引入警告處理模組，用於控制警告訊息</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np <span style="color:#75715e"># 引入數學運算和資料處理的基礎函式模組</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd <span style="color:#75715e"># 引入數學運算和資料處理的基礎函式模組</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pmdarima <span style="color:#66d9ef">as</span> pm <span style="color:#75715e"># 引入時間序列預測的 pmdarima 函式模組，它提供自動選擇 ARIMA 模型的功能</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> statsmodels.api <span style="color:#66d9ef">as</span> sm <span style="color:#75715e"># 引入統計模型和擬合的 statsmodels 函式模組，並提供時間序列分析的方法</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt <span style="color:#75715e"># 引入繪圖函式模組，用於資料視覺化</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os<span style="color:#f92672">,</span> zipfile <span style="color:#75715e"># 引入操作系統和壓縮檔案的函式模組，用於檔案操作和解壓縮</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dateutil <span style="color:#f92672">import</span> parser <span style="color:#66d9ef">as</span> datetime_parser <span style="color:#75715e"># 引入日期時間解析工具</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> statsmodels.tsa.arima.model <span style="color:#f92672">import</span> ARIMA <span style="color:#75715e"># 引入時間序列模型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> statsmodels.tsa.statespace.sarimax <span style="color:#f92672">import</span> SARIMAX <span style="color:#75715e"># 引入時間序列模型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> statsmodels.tsa.stattools <span style="color:#f92672">import</span> adfuller, kpss <span style="color:#75715e"># 引入時間序列穩定性檢測工具</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kats.consts <span style="color:#f92672">import</span> TimeSeriesData, TimeSeriesIterator <span style="color:#75715e"># 引入 Kats（Facebook 提供的時間序列工具箱）的基本結構和工具</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kats.detectors.outlier <span style="color:#f92672">import</span> OutlierDetector <span style="color:#75715e"># 引入 Kats 的異常值檢測工具</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kats.models.prophet <span style="color:#f92672">import</span> ProphetModel, ProphetParams <span style="color:#75715e"># 引入 Kats 提供的 Prophet 模型，及其參數設定</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kats.models.lstm <span style="color:#f92672">import</span> LSTMModel, LSTMParams <span style="color:#75715e"># 引入 Kats 提供的 LSTM 模型，及其參數設定</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kats.models.holtwinters <span style="color:#f92672">import</span> HoltWintersParams, HoltWintersModel <span style="color:#75715e"># 引入 Kats 提供的 Holt-Winters 模型及其參數設定</span>
</span></span></code></pre></div><h2 id="讀取資料">讀取資料</h2>
<p>本章節的探討主題為時序資料的資料預測，因此我們將分別以民生公共物聯網資料平台上的空品、水位和氣象資料進行資料讀取的演示，接著再使用空品資料進行更進一步的探究。其中，每一類別的資料處理都將使用其中一個測站長期以來觀測到的資料作為資料集，而在 dataframe 的時間欄位名稱則為設為 timestamp，由於時間欄位的數值具有唯一性，因此我們也將使用此欄位作為 dataframe 的索引 (index)。</p>
<h3 id="空品資料">空品資料</h3>
<p>由於我們這次要使用的是長時間的歷史資料，因此我們不直接使用 pyCIOT 套件的讀取資料功能，而直接從民生公共物聯網資料平台的歷史資料庫下載「中研院校園空品微型感測器」的歷史資料，並存入 Air 資料夾中。</p>
<p>同時，由於所下載的資料是 zip 壓縮檔案的格式，我們需要先逐一將其解壓縮，產生每日資料的壓縮檔案，接著再將每日資料的壓縮檔案解壓縮，存入 CSV_Air 資料夾中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>mkdir Air CSV_Air <span style="color:#75715e"># 創建資料夾來存放下載的資料和解壓縮後的 CSV 檔案</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 從指定網址下載 zip 檔案</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Air<span style="color:#f92672">/</span><span style="color:#ae81ff">2018.</span>zip <span style="color:#f92672">-</span>q <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bepuuawo%2BWTgeizqi</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3noJTpmaJf5qCh5ZyS56m65ZOB5b6u5Z6L5oSf5ris5ZmoLzIwMTguemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Air<span style="color:#f92672">/</span><span style="color:#ae81ff">2019.</span>zip <span style="color:#f92672">-</span>q <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bepuuawo%2BWTgeizqi</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3noJTpmaJf5qCh5ZyS56m65ZOB5b6u5Z6L5oSf5ris5ZmoLzIwMTkuemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Air<span style="color:#f92672">/</span><span style="color:#ae81ff">2020.</span>zip <span style="color:#f92672">-</span>q <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bepuuawo%2BWTgeizqi</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3noJTpmaJf5qCh5ZyS56m65ZOB5b6u5Z6L5oSf5ris5ZmoLzIwMjAuemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Air<span style="color:#f92672">/</span><span style="color:#ae81ff">2021.</span>zip <span style="color:#f92672">-</span>q <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bepuuawo%2BWTgeizqi</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3noJTpmaJf5qCh5ZyS56m65ZOB5b6u5Z6L5oSf5ris5ZmoLzIwMjEuemlw&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定義資料夾和副檔名的變數</span>
</span></span><span style="display:flex;"><span>folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Air&#39;</span>
</span></span><span style="display:flex;"><span>extension_zip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.zip&#39;</span>
</span></span><span style="display:flex;"><span>extension_csv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解壓縮第一層的 zip 檔案</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subfolder <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>subfolder<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> path<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>      print(path)
</span></span><span style="display:flex;"><span>      zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(path)
</span></span><span style="display:flex;"><span>      zip_ref<span style="color:#f92672">.</span>extractall(folder)
</span></span><span style="display:flex;"><span>      zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 檢查是否還有子資料夾中包含的 zip 檔案並進行解壓縮</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subfolder <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>subfolder<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> item<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>                file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                print(file_name)
</span></span><span style="display:flex;"><span>                zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(file_name)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>extractall(path)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 檢查更多層次的子資料夾中是否有 zip 檔，如果有則解壓縮</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path):
</span></span><span style="display:flex;"><span>          path2 <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path2):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> it <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path2):
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> it<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>                file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path2<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>it<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                print(file_name)
</span></span><span style="display:flex;"><span>                zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(file_name)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>extractall(<span style="color:#e6db74">&#39;CSV_Air&#39;</span>) <span style="color:#75715e"># 將解壓縮後的檔案儲存到指定資料夾</span>
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">elif</span> item<span style="color:#f92672">.</span>endswith(extension_csv): <span style="color:#75715e"># 如果找到 CSV 檔，則將它移到指定的資料夾</span>
</span></span><span style="display:flex;"><span>            os<span style="color:#f92672">.</span>rename(path2, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;CSV_Air/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>現在 CSV_Air 資料夾中即有每日所有感測器資料的 csv 格式檔案，為了將單一測站 (例如代碼為 <code>74DA38C7D2AC</code> 的測站) 的資料過濾出來，我們需要讀取每個 csv 檔案，並將檔案中該測站的資料存入名叫 air 的 dataframe 中。最後我們將所有下載的資料與解壓縮後產生的資料移除，以節省雲端的儲存空間。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 定義目標資料夾和檔案副檔名</span>
</span></span><span style="display:flex;"><span>folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;CSV_Air&#39;</span>
</span></span><span style="display:flex;"><span>extension_csv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
</span></span><span style="display:flex;"><span>id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;74DA38C7D2AC&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 創建空的 DataFrame 來存放讀取的資料</span>
</span></span><span style="display:flex;"><span>air <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>  file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>  df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(file_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 確保 pm25 欄位名稱是大寫的「PM25」</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;pm25&#39;</span> <span style="color:#f92672">in</span> list(df<span style="color:#f92672">.</span>columns):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>rename({<span style="color:#e6db74">&#39;pm25&#39;</span>:<span style="color:#e6db74">&#39;PM25&#39;</span>}, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 篩選出指定 device_id 的資料</span>
</span></span><span style="display:flex;"><span>  filtered <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;device_id==@id&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 合併到主要的 DataFrame 中</span>
</span></span><span style="display:flex;"><span>  air <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([air, filtered], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清除空的時間戳記欄位資料</span>
</span></span><span style="display:flex;"><span>air<span style="color:#f92672">.</span>dropna(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;timestamp&#39;</span>], inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將時間戳記欄位轉換為 datetime 格式且去除時區資訊</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, row <span style="color:#f92672">in</span> air<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>  aware <span style="color:#f92672">=</span> datetime_parser<span style="color:#f92672">.</span>parse(str(row[<span style="color:#e6db74">&#39;timestamp&#39;</span>]))
</span></span><span style="display:flex;"><span>  naive <span style="color:#f92672">=</span> aware<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>  air<span style="color:#f92672">.</span>at[i, <span style="color:#e6db74">&#39;timestamp&#39;</span>] <span style="color:#f92672">=</span> naive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將時間戳記設為 DataFrame 的索引</span>
</span></span><span style="display:flex;"><span>air<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 刪除原始的 Air 和 CSV_Air 資料夾</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>rm <span style="color:#f92672">-</span>rf Air CSV_Air
</span></span></code></pre></div><p>最後，我們重新整理該測站的資料，將不需要用到的欄位資訊刪除，並且依照時間進行排序如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 移除「device_id」和「SiteName」這兩個欄位</span>
</span></span><span style="display:flex;"><span>air<span style="color:#f92672">.</span>drop(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;device_id&#39;</span>, <span style="color:#e6db74">&#39;SiteName&#39;</span>], inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根據時間戳記排序資料</span>
</span></span><span style="display:flex;"><span>air<span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示資料集的簡要資訊</span>
</span></span><span style="display:flex;"><span>air<span style="color:#f92672">.</span>info()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示資料集的簡要資訊</span>
</span></span><span style="display:flex;"><span>print(air<span style="color:#f92672">.</span>info())
</span></span></code></pre></div><pre tabindex="0"><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
DatetimeIndex: 195305 entries, 2018-08-01 00:00:05 to 2021-12-31 23:54:46
Data columns (total 1 columns):
 \#   Column  Non-Null Count   Dtype 
---  ------  --------------   ----- 
 0   PM25    195305 non-null  object
dtypes: object(1)
memory usage: 3.0+ MB
                     PM25
timestamp                
2018-08-01 00:00:05  20.0
2018-08-01 00:30:18  17.0
2018-08-01 01:12:34  18.0
2018-08-01 01:18:36  21.0
2018-08-01 01:30:44  22.0
</code></pre><h3 id="水位資料">水位資料</h3>
<p>和空品資料的範例一樣，由於我們這次要使用的是長時間的歷史資料，因此我們不直接使用 pyCIOT 套件的讀取資料功能，而直接從民生公共物聯網資料平台的歷史資料庫下載「水利署地下水位站」的歷史資料，並存入 Water 資料夾中。</p>
<p>同時，由於所下載的資料是 zip 壓縮檔案的格式，我們需要先逐一將其解壓縮，產生每日資料的壓縮檔案，接著再將每日資料的壓縮檔案解壓縮，存入 CSV_Water 資料夾中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 建立資料夾存放下載的資料</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>mkdir Water CSV_Water
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下載 2018 到 2021 年的水質資料</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Water<span style="color:#f92672">/</span><span style="color:#ae81ff">2018.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2BawtOizh%2Ba6kC</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">msLTliKnnvbJf5rKz5bed5rC05L2N56uZLzIwMTguemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Water<span style="color:#f92672">/</span><span style="color:#ae81ff">2019.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2BawtOizh%2Ba6kC</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">msLTliKnnvbJf5rKz5bed5rC05L2N56uZLzIwMTkuemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Water<span style="color:#f92672">/</span><span style="color:#ae81ff">2020.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2BawtOizh%2Ba6kC</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">msLTliKnnvbJf5rKz5bed5rC05L2N56uZLzIwMjAuemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Water<span style="color:#f92672">/</span><span style="color:#ae81ff">2021.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2BawtOizh%2Ba6kC</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">msLTliKnnvbJf5rKz5bed5rC05L2N56uZLzIwMjEuemlw&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定義要解壓縮的目錄及檔案附檔名</span>
</span></span><span style="display:flex;"><span>folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Water&#39;</span>
</span></span><span style="display:flex;"><span>extension_zip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.zip&#39;</span>
</span></span><span style="display:flex;"><span>extension_csv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解壓縮主目錄下的 .zip 檔</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subfolder <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>subfolder<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> path<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>      print(path)
</span></span><span style="display:flex;"><span>      zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(path)
</span></span><span style="display:flex;"><span>      zip_ref<span style="color:#f92672">.</span>extractall(folder)
</span></span><span style="display:flex;"><span>      zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解壓縮子目錄下的 .zip 檔</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subfolder <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>subfolder<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> item<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>                file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                print(file_name)
</span></span><span style="display:flex;"><span>                zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(file_name)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>extractall(path)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 若子目錄中有更深層的資料夾，則將其中的 .zip 檔案也進行解壓縮</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path):
</span></span><span style="display:flex;"><span>          path2 <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path2):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> it <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path2):
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> it<span style="color:#f92672">.</span>endswith(extension_zip) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> it<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;QC.zip&#39;</span>):
</span></span><span style="display:flex;"><span>                file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path2<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>it<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                print(file_name)
</span></span><span style="display:flex;"><span>                zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(file_name)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>extractall(<span style="color:#e6db74">&#39;CSV_Water&#39;</span>) <span style="color:#75715e"># 決定解壓縮的目標路徑</span>
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">elif</span> item<span style="color:#f92672">.</span>endswith(extension_csv):
</span></span><span style="display:flex;"><span>            os<span style="color:#f92672">.</span>rename(path2, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;CSV_Water/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>現在 CSV_Water 資料夾中即有每日所有感測器資料的 csv 格式檔案，為了將單一測站 (例如代碼為 <code>338c9c1c-57d8-41d7-9af2-731fb86e632c</code> 的測站) 的資料過濾出來，我們需要讀取每個 csv 檔案，並將檔案中該測站的資料存入名叫 water 的 dataframe 中。最後我們將所有下載的資料與解壓縮後產生的資料移除，以節省雲端的儲存空間。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 定義資料夾位置和 CSV 檔案的副檔名</span>
</span></span><span style="display:flex;"><span>folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;CSV_Water&#39;</span>
</span></span><span style="display:flex;"><span>extension_csv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
</span></span><span style="display:flex;"><span>id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;338c9c1c-57d8-41d7-9af2-731fb86e632c&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化 DataFrame</span>
</span></span><span style="display:flex;"><span>water <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 讀取目錄下的所有 CSV 檔案</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>  file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>  df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(file_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 若資料列名有「pm25」，則將其更名為「PM25」</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;pm25&#39;</span> <span style="color:#f92672">in</span> list(df<span style="color:#f92672">.</span>columns):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>rename({<span style="color:#e6db74">&#39;pm25&#39;</span>:<span style="color:#e6db74">&#39;PM25&#39;</span>}, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 只選取特定 id 的資料</span>
</span></span><span style="display:flex;"><span>  filtered <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;station_id==@id&#39;</span>)
</span></span><span style="display:flex;"><span>  water <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([water, filtered], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除沒有 timestamp 的資料列</span>
</span></span><span style="display:flex;"><span>water<span style="color:#f92672">.</span>dropna(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;timestamp&#39;</span>], inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將 timestamp 的時區資訊移除</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, row <span style="color:#f92672">in</span> water<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>  aware <span style="color:#f92672">=</span> datetime_parser<span style="color:#f92672">.</span>parse(str(row[<span style="color:#e6db74">&#39;timestamp&#39;</span>]))
</span></span><span style="display:flex;"><span>  naive <span style="color:#f92672">=</span> aware<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>  water<span style="color:#f92672">.</span>at[i, <span style="color:#e6db74">&#39;timestamp&#39;</span>] <span style="color:#f92672">=</span> naive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將 timestamp 設定為資料框的索引</span>
</span></span><span style="display:flex;"><span>water<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除不需要的資料夾</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>rm <span style="color:#f92672">-</span>rf Water CSV_Water
</span></span></code></pre></div><p>最後，我們重新整理該測站的資料，將不需要用到的欄位資訊刪除，並且依照時間進行排序如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 移除不需要的資料欄</span>
</span></span><span style="display:flex;"><span>water<span style="color:#f92672">.</span>drop(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;station_id&#39;</span>, <span style="color:#e6db74">&#39;ciOrgname&#39;</span>, <span style="color:#e6db74">&#39;ciCategory&#39;</span>, <span style="color:#e6db74">&#39;Organize_Name&#39;</span>, <span style="color:#e6db74">&#39;CategoryInfos_Name&#39;</span>, <span style="color:#e6db74">&#39;PQ_name&#39;</span>, <span style="color:#e6db74">&#39;PQ_fullname&#39;</span>, <span style="color:#e6db74">&#39;PQ_description&#39;</span>, <span style="color:#e6db74">&#39;PQ_unit&#39;</span>, <span style="color:#e6db74">&#39;PQ_id&#39;</span>], inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根據 timestamp 排序資料</span>
</span></span><span style="display:flex;"><span>water<span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示資料的基本資訊</span>
</span></span><span style="display:flex;"><span>water<span style="color:#f92672">.</span>info()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示前五筆資料</span>
</span></span><span style="display:flex;"><span>print(water<span style="color:#f92672">.</span>head())
</span></span></code></pre></div><pre tabindex="0"><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
DatetimeIndex: 213466 entries, 2018-01-01 00:20:00 to 2021-12-07 11:00:00
Data columns (total 1 columns):
 \#   Column  Non-Null Count   Dtype  
---  ------  --------------   -----  
 0   value   213465 non-null  float64
dtypes: float64(1)
memory usage: 3.3 MB
                         value
timestamp                     
2018-01-01 00:20:00  49.130000
2018-01-01 00:25:00  49.139999
2018-01-01 00:30:00  49.130001
2018-01-01 00:35:00  49.130001
2018-01-01 00:40:00  49.130001
</code></pre><h3 id="氣象資料">氣象資料</h3>
<p>我們從民生公共物聯網資料平台的歷史資料庫下載「中央氣象局自動氣象站」的歷史資料，並存入 Weather 資料夾中。</p>
<p>同時，由於所下載的資料是 zip 壓縮檔案的格式，我們需要先逐一將其解壓縮，產生每日資料的壓縮檔案，接著再將每日資料的壓縮檔案解壓縮，存入 CSV_Weather 資料夾中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 建立 Weather 和 CSV_Weather 資料夾</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>mkdir Weather CSV_Weather
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 從指定網址下載資料並儲存至 Weather 資料夾</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Weather<span style="color:#f92672">/</span><span style="color:#ae81ff">2019.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bawo%2BixoS</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3lpK7msKPosaHlsYBf6Ieq5YuV5rCj6LGh56uZLzIwMTkuemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Weather<span style="color:#f92672">/</span><span style="color:#ae81ff">2020.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bawo%2BixoS</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3lpK7msKPosaHlsYBf6Ieq5YuV5rCj6LGh56uZLzIwMjAuemlw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>O Weather<span style="color:#f92672">/</span><span style="color:#ae81ff">2021.</span>zip <span style="color:#e6db74">&#34;https://history.colife.org.tw/?r=/download&amp;path=L%2Bawo%2BixoS</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">kuK3lpK7msKPosaHlsYBf6Ieq5YuV5rCj6LGh56uZLzIwMjEuemlw&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定義要解壓縮的目錄及檔案附檔名</span>
</span></span><span style="display:flex;"><span>folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Weather&#39;</span>
</span></span><span style="display:flex;"><span>extension_zip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.zip&#39;</span>
</span></span><span style="display:flex;"><span>extension_csv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解壓縮主目錄下的 zip 檔案</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subfolder <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>subfolder<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> path<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>      print(path)
</span></span><span style="display:flex;"><span>      zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(path)
</span></span><span style="display:flex;"><span>      zip_ref<span style="color:#f92672">.</span>extractall(folder)
</span></span><span style="display:flex;"><span>      zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 對 Weather 目錄下的子目錄進行解壓縮</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subfolder <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>subfolder<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> item<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>                file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                print(file_name)
</span></span><span style="display:flex;"><span>                zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(file_name)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>extractall(path)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 對子目錄中的子目錄進行解壓縮，並將 csv 檔案移至 CSV_Weather 資料夾</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path):
</span></span><span style="display:flex;"><span>          path2 <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path2):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> it <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(path2):
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> it<span style="color:#f92672">.</span>endswith(extension_zip):
</span></span><span style="display:flex;"><span>                file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>path2<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>it<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                print(file_name)
</span></span><span style="display:flex;"><span>                zip_ref <span style="color:#f92672">=</span> zipfile<span style="color:#f92672">.</span>ZipFile(file_name)
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>extractall(<span style="color:#e6db74">&#39;CSV_Weather&#39;</span>) <span style="color:#75715e"># 解壓縮至指定目錄</span>
</span></span><span style="display:flex;"><span>                zip_ref<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">elif</span> item<span style="color:#f92672">.</span>endswith(extension_csv):
</span></span><span style="display:flex;"><span>            os<span style="color:#f92672">.</span>rename(path2, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;CSV_Weather/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>現在 CSV_Weather 資料夾中即有每日所有感測器資料的 csv 格式檔案，為了將單一測站 (例如代碼為 <code>C0U750</code> 的測站) 的資料過濾出來，我們需要讀取每個 csv 檔案，並將檔案中該測站的資料存入名叫 weather 的 dataframe 中。最後我們將所有下載的資料與解壓縮後產生的資料移除，以節省雲端的儲存空間。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 設定資料夾路徑和副檔名</span>
</span></span><span style="display:flex;"><span>folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;CSV_Weather&#39;</span>
</span></span><span style="display:flex;"><span>extension_csv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
</span></span><span style="display:flex;"><span>id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C0U750&#39;</span> <span style="color:#75715e"># 指定要篩選的站點 ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 建立一個空的 DataFrame，用於儲存結果</span>
</span></span><span style="display:flex;"><span>weather <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 讀取 CSV_Weather 資料夾中的所有 csv 檔案</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>  file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>folder<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>item<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>  df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(file_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 若 csv 檔中有「pm25」欄位，將其重新命名為「PM25」</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;pm25&#39;</span> <span style="color:#f92672">in</span> list(df<span style="color:#f92672">.</span>columns):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>rename({<span style="color:#e6db74">&#39;pm25&#39;</span>:<span style="color:#e6db74">&#39;PM25&#39;</span>}, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 依據站點 ID 篩選資料</span>
</span></span><span style="display:flex;"><span>  filtered <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;station_id==@id&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 將篩選後的資料加入 weather DataFrame</span>
</span></span><span style="display:flex;"><span>  weather <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([weather, filtered], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新命名某些欄位以便統一命名規則</span>
</span></span><span style="display:flex;"><span>weather<span style="color:#f92672">.</span>rename({<span style="color:#e6db74">&#39;obsTime&#39;</span>:<span style="color:#e6db74">&#39;timestamp&#39;</span>}, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除缺失 timestamp 的資料</span>
</span></span><span style="display:flex;"><span>weather<span style="color:#f92672">.</span>dropna(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;timestamp&#39;</span>], inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將 timestamp 轉換成 datetime 格式且移除時區資訊</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, row <span style="color:#f92672">in</span> weather<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>  aware <span style="color:#f92672">=</span> datetime_parser<span style="color:#f92672">.</span>parse(str(row[<span style="color:#e6db74">&#39;timestamp&#39;</span>]))
</span></span><span style="display:flex;"><span>  naive <span style="color:#f92672">=</span> aware<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>  weather<span style="color:#f92672">.</span>at[i, <span style="color:#e6db74">&#39;timestamp&#39;</span>] <span style="color:#f92672">=</span> naive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定 timestamp 為 DataFrame 的索引</span>
</span></span><span style="display:flex;"><span>weather<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 刪除資料夾以釋放空間</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>rm <span style="color:#f92672">-</span>rf Weather CSV_Weather
</span></span></code></pre></div><p>最後，我們重新整理該測站的資料，將不需要用到的欄位資訊刪除，並且依照時間進行排序如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 移除不需要的欄位「station_id」</span>
</span></span><span style="display:flex;"><span>weather<span style="color:#f92672">.</span>drop(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;station_id&#39;</span>], inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根據「timestamp」欄位進行排序</span>
</span></span><span style="display:flex;"><span>weather<span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示 DataFrame 的資訊摘要，包括每列的非空值數、資料型態等</span>
</span></span><span style="display:flex;"><span>weather<span style="color:#f92672">.</span>info()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示 DataFrame 的前五行以確認資料結構</span>
</span></span><span style="display:flex;"><span>print(weather<span style="color:#f92672">.</span>head())
</span></span></code></pre></div><pre tabindex="0"><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
DatetimeIndex: 27093 entries, 2019-01-01 00:00:00 to 2021-12-31 23:00:00
Data columns (total 15 columns):
 \#   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
 0   ELEV    27093 non-null  float64
 1   WDIR    27089 non-null  float64
 2   WDSD    27089 non-null  float64
 3   TEMP    27093 non-null  float64
 4   HUMD    27089 non-null  float64
 5   PRES    27093 non-null  float64
 6   SUN     13714 non-null  float64
 7   H_24R   27089 non-null  float64
 8   H_FX    27089 non-null  float64
 9   H_XD    27089 non-null  object 
 10  H_FXT   23364 non-null  object 
 11  D_TX    27074 non-null  object 
 12  D_TXT   7574 non-null   object 
 13  D_TN    27074 non-null  object 
 14  D_TNT   17 non-null     object 
dtypes: float64(9), object(6)
memory usage: 3.3+ MB
                      ELEV  WDIR  WDSD  TEMP  HUMD   PRES   SUN  H_24R  H_FX  \
timestamp                                                                      
2019-01-01 00:00:00  398.0  35.0   5.8  13.4  0.99  981.1 -99.0   18.5 -99.0   
2019-01-01 01:00:00  398.0  31.0   5.7  14.1  0.99  981.0 -99.0    0.5  10.8   
2019-01-01 02:00:00  398.0  35.0   5.3  13.9  0.99  980.7 -99.0    1.0 -99.0   
2019-01-01 03:00:00  398.0  32.0   5.7  13.8  0.99  980.2 -99.0    1.5 -99.0   
2019-01-01 04:00:00  398.0  37.0   6.9  13.8  0.99  980.0 -99.0    2.0  12.0   

                     H_XD H_FXT  D_TX D_TXT  D_TN D_TNT  
timestamp                                                
2019-01-01 00:00:00 -99.0 -99.0  14.5   NaN  13.4   NaN  
2019-01-01 01:00:00  35.0   NaN  14.1   NaN  13.5   NaN  
2019-01-01 02:00:00 -99.0 -99.0  14.1   NaN  13.5   NaN  
2019-01-01 03:00:00 -99.0 -99.0  14.1   NaN  13.5   NaN  
2019-01-01 04:00:00  39.0   NaN  14.1   NaN  13.5   NaN
</code></pre><p>以上我們已經成功示範空品資料 (air)、水位資料 (water) 和氣象資料 (weather) 的讀取範例，在接下來的探討中，我們將以空品資料示範初步的時間序列資料處理，相同的方法也可以輕易改成使用水位資料或氣象資料而得到類似的結果，大家可以自行嘗試看看。</p>
<h2 id="資料預處理-preprocess">資料預處理 (Preprocess)</h2>
<p>我們首先依照章節 4.1 所介紹的方法對資料進行重新採樣，將資料分別取每小時平均 (air_hour)、每天平均 (air_day) 和每月平均 (air_month)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 針對「air」DataFrame，使用 resample 並根據每小時對資料取平均值</span>
</span></span><span style="display:flex;"><span>air_hour <span style="color:#f92672">=</span> air<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;H&#39;</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 針對「air」DataFrame，使用 resample 並根據每日對資料取平均值</span>
</span></span><span style="display:flex;"><span>air_day <span style="color:#f92672">=</span> air<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;D&#39;</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 針對「air」DataFrame，使用 resample 並根據每月對資料取平均值</span>
</span></span><span style="display:flex;"><span>air_month <span style="color:#f92672">=</span> air<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;M&#39;</span>)<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><p>接著我們依照章節 4.1 所介紹的離群值偵測方法，將 air_hour 資料中的離群值移除，並將移除後的缺失資料，使用 Forward fill 方法填回。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 將 air_hour 轉換為 TimeSeriesData 格式</span>
</span></span><span style="display:flex;"><span>air_ts <span style="color:#f92672">=</span> TimeSeriesData(air_hour<span style="color:#f92672">.</span>reset_index(), time_col_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 OutlierDetector 進行離群值檢測</span>
</span></span><span style="display:flex;"><span>outlierDetection <span style="color:#f92672">=</span> OutlierDetector(air_ts, <span style="color:#e6db74">&#39;additive&#39;</span>)
</span></span><span style="display:flex;"><span>outlierDetection<span style="color:#f92672">.</span>detector()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除離群值，這裡選擇不插值</span>
</span></span><span style="display:flex;"><span>outliers_removed <span style="color:#f92672">=</span> outlierDetection<span style="color:#f92672">.</span>remover(interpolate<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將檢測後的資料轉回 DataFrame 並重新命名欄位</span>
</span></span><span style="display:flex;"><span>air_hour_df <span style="color:#f92672">=</span> outliers_removed<span style="color:#f92672">.</span>to_dataframe()
</span></span><span style="display:flex;"><span>air_hour_df<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;time&#39;</span>: <span style="color:#e6db74">&#39;timestamp&#39;</span>, <span style="color:#e6db74">&#39;y_0&#39;</span>: <span style="color:#e6db74">&#39;PM25&#39;</span>}, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將 timestamp 設定為索引</span>
</span></span><span style="display:flex;"><span>air_hour_df<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;timestamp&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>air_hour <span style="color:#f92672">=</span> air_hour_df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新取樣為每小時並取平均值</span>
</span></span><span style="display:flex;"><span>air_hour <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;H&#39;</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用 Forward 方法填回缺失值</span>
</span></span><span style="display:flex;"><span>air_hour<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="平穩性-stationary-檢查">平穩性 (Stationary) 檢查</h2>
<p>在進行資料預測的探究前，我們先針對資料的<a href="https://www.itl.nist.gov/div898/handbook/pmc/section4/pmc442.htm">平穩性 (stationary)</a> 進行檢查。我們先挑選想要進行檢測的時間區段（例如 2020-06-10 ~ 2020-06-17），並將這個區段的資料存入 data 變數。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 選擇日期範圍從 2020 年 6 月 10 日到 2020 年 6 月 17 日的資料</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-10&#39;</span>:<span style="color:#e6db74">&#39;2020-06-17&#39;</span>]
</span></span></code></pre></div><p>接著我們計算這些資料的平均數 (mean) 與變異數 (var)，並且進行繪圖。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 將 data.PM25 的資料轉換為 numpy array</span>
</span></span><span style="display:flex;"><span>nmp <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>PM25<span style="color:#f92672">.</span>to_numpy()
</span></span><span style="display:flex;"><span>size <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>size(nmp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化存儲累積平均和變異數的 array</span>
</span></span><span style="display:flex;"><span>nmp_mean <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(size) 
</span></span><span style="display:flex;"><span>nmp_var <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 計算每一步的累積平均和變異數</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(size):
</span></span><span style="display:flex;"><span>  nmp_mean[i] <span style="color:#f92672">=</span> nmp[:i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>mean() <span style="color:#75715e"># 到目前為止的平均</span>
</span></span><span style="display:flex;"><span>  nmp_var[i] <span style="color:#f92672">=</span> nmp[:i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>var() <span style="color:#75715e"># 到目前為止的變異數</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 準備畫圖的資料</span>
</span></span><span style="display:flex;"><span>y1 <span style="color:#f92672">=</span> nmp_mean[:]
</span></span><span style="display:flex;"><span>y2 <span style="color:#f92672">=</span> nmp_var[:]
</span></span><span style="display:flex;"><span>y3 <span style="color:#f92672">=</span> nmp
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 matplotlib 繪製累積平均和變異數的圖表</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(x, y1, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mean&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(x, y2, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;var&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><p><img src="figures/4-2-2-1.png" alt="Python output"></p>
<p>從圖中可以發現平均數的變化不大，但是變異數的變化卻很大。我們稱這樣的資料具備較差的平穩性；相反地，若是具備平穩性的資料，其平均數與變異數的變化不會與時間的推移有關。</p>
<p>換句話說，如果資料分布隨著時間有一定的趨勢變化，那它就沒有平穩性；如果資料的分佈不會因為時間推移，平均數與變異數也維持固定，那它就有平穩性 (stationary)。平穩性的資料有利於尋找適合的的模型 (model) 並預測未來的數值。</p>
<p>若要檢查資料是否具有平穩性，至少有下列兩種常見的方法：</p>
<ol>
<li>Augmented Dickey Fuller (ADF) test：使用 <a href="https://en.wikipedia.org/wiki/Unit_root_test">unit root test</a>，如果 <em>p-value</em> &lt; 0.05，則資料具有平穩性。</li>
<li>Kwiatkowski-Phillips-Schmidt-Shin (KPSS) test：與 ADF test 相反，如果 <em>p-value</em> &lt; 0.05，則資料不具有平穩性 (non-stationary)。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 執行 ADF 檢定</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> adfuller(data<span style="color:#f92672">.</span>PM25<span style="color:#f92672">.</span>values, autolag<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AIC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示 ADF 檢定結果</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;ADF Statistic: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># ADF 統計值</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;p-value: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># p 值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 輸出 ADF 檢定的臨界值</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> result[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Critial Values:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;   </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 執行 KPSS 檢定</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> kpss(data<span style="color:#f92672">.</span>PM25<span style="color:#f92672">.</span>values, regression<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;c&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示 KPSS 檢定結果</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">KPSS Statistic: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> result[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e"># KPSS 統計值</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;p-value: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> result[<span style="color:#ae81ff">1</span>]) <span style="color:#75715e"># p 值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示 KPSS 檢定的臨界值</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> result[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Critial Values:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;   </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><pre tabindex="0"><code>ADF Statistic: -2.7026194088541704
p-value: 0.07358609270498144
Critial Values:
   1%, -3.4654311561944873
Critial Values:
   5%, -2.8769570530458792
Critial Values:
   10%, -2.574988319755886

KPSS Statistic: 0.620177
p-value: 0.020802
Critial Values:
   10%, 0.347
Critial Values:
   5%, 0.463
Critial Values:
   2.5%, 0.574
Critial Values:
   1%, 0.739
</code></pre><p>若以我們使用的範例資料為例，經過 ADF 檢測得到的 <em>p-value</em> 為 0.073，因此該資料並沒有平穩性。為了達到平穩性，我們接下來將資料進行差分，也就是將第 i 筆資料減第 i-1 筆資料，並使用得到的結果再次進行檢測。</p>
<p>在 dataframe 的資料格式上我們可以直接使用 <code>data.diff()</code> 來將資料差分 ，並將經過差分後的資料命名為 <code>data_diff</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 對 data 進行一階差分</span>
</span></span><span style="display:flex;"><span>data_diff <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>diff()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示差分後的資料</span>
</span></span><span style="display:flex;"><span>data_diff
</span></span></code></pre></div><pre tabindex="0"><code>                         PM25
timestamp	
2020-06-10 00:00:00	NaN
2020-06-10 01:00:00	-14.700000
2020-06-10 02:00:00	-8.100000
2020-06-10 03:00:00	0.200000
2020-06-10 04:00:00	-1.900000
...	...
2020-06-17 19:00:00	0.750000
2020-06-17 20:00:00	4.875000
2020-06-17 21:00:00	-3.375000
2020-06-17 22:00:00	1.930556
2020-06-17 23:00:00	3.944444
</code></pre><p>我們可以看到第一筆資料為 <em>Nan</em>，這是因為第一筆資料無法減去前一筆資料，所以我們要將第一筆資料捨棄。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 從 data_diff 中移除第一筆資料</span>
</span></span><span style="display:flex;"><span>data_diff <span style="color:#f92672">=</span> data_diff[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示修改後的 data_diff</span>
</span></span><span style="display:flex;"><span>data_diff
</span></span></code></pre></div><pre tabindex="0"><code>                         PM25
timestamp	
2020-06-10 01:00:00	-14.700000
2020-06-10 02:00:00	-8.100000
2020-06-10 03:00:00	0.200000
2020-06-10 04:00:00	-1.900000
2020-06-10 05:00:00	-1.300000
...	...
2020-06-17 19:00:00	0.750000
2020-06-17 20:00:00	4.875000
2020-06-17 21:00:00	-3.375000
2020-06-17 22:00:00	1.930556
2020-06-17 23:00:00	3.944444
</code></pre><p>接著我們將資料繪圖來觀察經過差分後資料的平均數與變異數隨時間變化的關係。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 從一階差分資料中取出 PM2.5 的值</span>
</span></span><span style="display:flex;"><span>nmp <span style="color:#f92672">=</span> data_diff<span style="color:#f92672">.</span>PM25<span style="color:#f92672">.</span>to_numpy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 計算總共有多少資料點</span>
</span></span><span style="display:flex;"><span>size <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>size(nmp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化兩個陣列，分別儲存時序資料的累計平均和累計變異數</span>
</span></span><span style="display:flex;"><span>nmp_mean <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(size)
</span></span><span style="display:flex;"><span>nmp_var <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 透過迴圈，對每個時間點計算到目前為止的累計平均和變異數</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(size):
</span></span><span style="display:flex;"><span>  nmp_mean[i] <span style="color:#f92672">=</span> nmp[:i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>mean() <span style="color:#75715e"># 計算到第i個時間點的平均</span>
</span></span><span style="display:flex;"><span>  nmp_var[i] <span style="color:#f92672">=</span> nmp[:i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>var() <span style="color:#75715e"># 計算到第i個時間點的變異數</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 建立資料序列以便於繪圖</span>
</span></span><span style="display:flex;"><span>y1 <span style="color:#f92672">=</span> nmp_mean[:] <span style="color:#75715e"># 累計平均的資料序列</span>
</span></span><span style="display:flex;"><span>y2 <span style="color:#f92672">=</span> nmp_var[:] <span style="color:#75715e"># 累計變異數的資料序列</span>
</span></span><span style="display:flex;"><span>y3 <span style="color:#f92672">=</span> nmp <span style="color:#75715e"># 原始資料序列</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(size) <span style="color:#75715e"># x軸，代表時間點</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用matplotlib進行資料繪圖</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(x, y1, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mean&#39;</span>) <span style="color:#75715e"># 繪製累計平均</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(x, y2, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;var&#39;</span>) <span style="color:#75715e"># 繪製累計變異數</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend() <span style="color:#75715e"># 繪製累計變異數</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show() <span style="color:#75715e"># 顯示圖形</span>
</span></span></code></pre></div><p><img src="figures/4-2-2-2.png" alt="Python output"></p>
<p>從以上的結果我們發現平均數的變化依然不大，而變異數的變化則變小了。我們接著重複上述的平穩性檢測步驟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用 ADF (Augmented Dickey-Fuller) 測試檢查資料的定態性</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> adfuller(data_diff<span style="color:#f92672">.</span>PM25<span style="color:#f92672">.</span>values, autolag<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AIC&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;ADF Statistic: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># 輸出ADF統計值</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;p-value: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># 輸出p值，通常小於0.05表示資料是定態的</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 輸出不同信賴度下的臨界值，與 ADF 統計值進行比較</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> result[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Critial Values:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;   </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 KPSS (Kwiatkowski-Phillips-Schmidt-Shin) 測試檢查資料的定態性</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> kpss(data_diff<span style="color:#f92672">.</span>PM25<span style="color:#f92672">.</span>values, regression<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;c&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">KPSS Statistic: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> result[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e"># 輸出 KPSS 統計值</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;p-value: </span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> result[<span style="color:#ae81ff">1</span>]) <span style="color:#75715e"># 輸出 p 值，通常大於 0.05 表示資料是定態的</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 輸出不同信賴度下的臨界值，與 KPSS 統計值進行比較</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> result[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Critial Values:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;   </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><pre tabindex="0"><code>ADF Statistic: -13.350457196046884
p-value: 5.682260865619701e-25
Critial Values:
   1%, -3.4654311561944873
Critial Values:
   5%, -2.8769570530458792
Critial Values:
   10%, -2.574988319755886

KPSS Statistic: 0.114105
p-value: 0.100000
Critial Values:
   10%, 0.347
Critial Values:
   5%, 0.463
Critial Values:
   2.5%, 0.574
Critial Values:
   1%, 0.739
</code></pre><p>經過檢測後得到 ADF test 的 <em>p-value</em> 為 5.68e-25，由此可知經過一次差分後的資料便具有平穩性，這個結果會在本章節後續的預測模型使用到。</p>
<h2 id="資料預測data-forecast">資料預測(Data forecast)</h2>
<p>經過前一部分的預處理後，這邊我們將會示範使用不同的預測模型來對時序資料進行預測，我們將依次使用 <a href="https://otexts.com/fpp2/arima.html">ARIMA</a>、<a href="https://www.statsmodels.org/stable/examples/notebooks/generated/statespace_sarimax_stata.html">SARIMAX</a>、<a href="https://alkaline-ml.com/pmdarima/modules/generated/pmdarima.arima.auto_arima.html">auto_arima</a>、<a href="https://facebook.github.io/prophet/">Prophet</a>、<a href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTM</a> 與 <a href="https://otexts.com/fpp2/holt-winters.html">Holt-Winter</a> 模型。</p>
<h3 id="arima">ARIMA</h3>
<p>ARIMA 模型其實是 ARMA 模型的擴展版本，因此我們先介紹先介紹 ARMA 模型，並將 ARMA 模型拆成兩部分，分別是:</p>
<ol>
<li>自迴歸模型 (AR, autogressive model)：使用一個參數 <em>p</em>，並以前 <em>p</em> 個歷史值做線性組合來預測當下的數值。</li>
<li>移動平均模型 (MA, moving average model)：使用一個參數 <em>q</em>，並以前 <em>q</em> 個使用 AR 模型的預測誤差進行線性組合，以預測當下的數值。</li>
</ol>
<p>而 ARIMA 模型比 ARMA 模型還多使用一個參數 <em>d</em>，還記得前面的平穩性檢查嗎？如果資料不具有平穩性就要做差分，而參數 <em>d</em> 就代表需要做差分的次數。</p>
<p>以下我們使用空品資料進行演練。首先，我們將資料製圖以選擇要使用的資料片段：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用 .loc 方法從資料集 air_hour 中選取 2020 年 6 月 1 日到 2020 年 6 月 30 日期間的 PM2.5 資料</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 之後對此段時間內的 PM2.5 數值進行繪圖</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># figsize 參數確保圖形的大小為 12x8 英吋</span>
</span></span><span style="display:flex;"><span>air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-01&#39;</span>:<span style="color:#e6db74">&#39;2020-06-30&#39;</span>][<span style="color:#e6db74">&#39;PM25&#39;</span>]<span style="color:#f92672">.</span>plot(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>))
</span></span></code></pre></div><p><img src="figures/4-2-3-1.png" alt="Python output"></p>
<p>我們選擇一段想要使用的資料，並將資料分為兩部分：</p>
<ol>
<li>訓練資料 (train data)：用來訓練模型，找出最適合模型的參數。</li>
<li>測試資料 (test data)：當得到訓練模型後，可用於評估該模型在資料預測上的準確度。</li>
</ol>
<p>在我們接下來的範例中，我們設定測試資料的長度為 48 小時 (<code>train_len=-48</code>)，訓練資料則為扣除最後 48 小時的全部資料。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 從 air_hour 資料集中選擇 2020 年 6 月 17 日到 2020 年 6 月 21 日期間的資料</span>
</span></span><span style="display:flex;"><span>data_arima <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-17&#39;</span>:<span style="color:#e6db74">&#39;2020-06-21&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定義訓練資料的長度。由於訓練資料末端是測試資料的開始，所以使用負數表示從資料末端算回去的資料點數</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 這裡的 -48 代表訓練資料的最後 48 個資料點將作為測試資料</span>
</span></span><span style="display:flex;"><span>train_len <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 iloc 函式根據上面定義的 train_len 從 data_arima 中取得訓練資料</span>
</span></span><span style="display:flex;"><span>train <span style="color:#f92672">=</span> data_arima<span style="color:#f92672">.</span>iloc[:train_len]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將剩餘的資料作為測試資料</span>
</span></span><span style="display:flex;"><span>test <span style="color:#f92672">=</span> data_arima<span style="color:#f92672">.</span>iloc[train_len:]
</span></span></code></pre></div><p>我們首先判斷這段資料是具有平穩性，並以差分的次數決定 <em>d</em> 參數的數值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 進行 Dickey-Fuller 單根檢定以檢查訓練資料集的定態性</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> adfuller(train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 輸出檢定統計值</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;The test stastics:&#39;</span>, result[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 輸出 p 值。p 值低於特定臨界值 (如 0.05) 時，我們將拒絕原假設，認為時間序列是定態的</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;The p-value:&#34;</span>, result[<span style="color:#ae81ff">1</span>])
</span></span></code></pre></div><pre tabindex="0"><code>The test stastics: -3.1129543556288826
The p-value: 0.025609243615341074
</code></pre><p>由於 <em>p-value</em> 已經比 0.05 小，因此我們不需要進行差分（亦即 <em>d</em>=0）即可繼續探討 ARIMA模型中的參數 <em>p</em> 和參數 <em>q</em>，而比較簡單的方法就是將可能的 <em>p</em>、<em>q</em> 組合分別帶入模型後，再從中判斷模型的好壞。</p>
<p>我們可以使用 <a href="https://en.wikipedia.org/wiki/Akaike_information_criterion">AIC</a> 或 <a href="https://en.wikipedia.org/wiki/Bayesian_information_criterion">BIC</a> 方法，來判斷模型跟訓練資料是否擬合，一般來說，其判斷出來的數值越小代表模型的效果越好。例如，我們先將 <em>p</em> 和 <em>q</em> 的範圍限制在 0~2 之間，這樣總共有 9 種可能的組合，再分別查看其 AIC 與 BIC 的數值，並以數值最小的 <em>p</em> 和 <em>q</em> 組合，作為這兩個參數的決定值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 忽略所有警告，使輸出更加乾淨</span>
</span></span><span style="display:flex;"><span>warnings<span style="color:#f92672">.</span>filterwarnings(<span style="color:#e6db74">&#39;ignore&#39;</span>)
</span></span><span style="display:flex;"><span>order_aic_bic <span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 對 p 值（AR 項）進行 0 到 2 的迴圈</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 對 q 值（MA 項）進行 0 到 2 的迴圈</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> q <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span>):
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 創建並擬合 SARIMA (p,0,q) 模型（其中 d（差分項）被固定為 0）</span>
</span></span><span style="display:flex;"><span>            model <span style="color:#f92672">=</span> sm<span style="color:#f92672">.</span>tsa<span style="color:#f92672">.</span>statespace<span style="color:#f92672">.</span>SARIMAX(train[<span style="color:#e6db74">&#39;PM25&#39;</span>], order<span style="color:#f92672">=</span>(p, <span style="color:#ae81ff">0</span>, q))
</span></span><span style="display:flex;"><span>            results <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 將 p, q 和計算出的 AIC、BIC 值存儲起來</span>
</span></span><span style="display:flex;"><span>            order_aic_bic<span style="color:#f92672">.</span>append((p, q, results<span style="color:#f92672">.</span>aic, results<span style="color:#f92672">.</span>bic))            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 若模型無法擬合，輸出 p 和 q 值</span>
</span></span><span style="display:flex;"><span>            print(p, q, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將 p, q 值及其相應的 AIC、BIC 轉換成 DataFrame</span>
</span></span><span style="display:flex;"><span>order_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(order_aic_bic, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;p&#39;</span>, <span style="color:#e6db74">&#39;q&#39;</span>, <span style="color:#e6db74">&#39;aic&#39;</span>,<span style="color:#e6db74">&#39;bic&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根據 AIC 和 BIC 對模型進行排序</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根據 AIC 排序</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Sorted by AIC &#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(&#34;\n&#34;)</span>
</span></span><span style="display:flex;"><span>print(order_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;aic&#39;</span>)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根據 BIC 排序</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Sorted by BIC &#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(&#34;\n&#34;)</span>
</span></span><span style="display:flex;"><span>print(order_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;bic&#39;</span>)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span></code></pre></div><pre tabindex="0"><code>Sorted by AIC 
   p  q         aic         bic
0  1  0  349.493661  354.046993
1  1  1  351.245734  358.075732
2  2  0  351.299268  358.129267
3  1  2  352.357930  361.464594
4  2  1  353.015921  362.122586
5  2  2  353.063243  364.446574
6  0  2  402.213407  409.043405
7  0  1  427.433962  431.987294
8  0  0  493.148188  495.424854
Sorted by BIC 
   p  q         aic         bic
0  1  0  349.493661  354.046993
1  1  1  351.245734  358.075732
2  2  0  351.299268  358.129267
3  1  2  352.357930  361.464594
4  2  1  353.015921  362.122586
5  2  2  353.063243  364.446574
6  0  2  402.213407  409.043405
7  0  1  427.433962  431.987294
8  0  0  493.148188  495.424854
</code></pre><p>我們可以發現當 (<em>p</em>,<em>q</em>) = (1,0) 時，AIC 和 BIC 的值最小，代表這是最好的模型組態，因此我們決定 <em>p</em>、<em>d</em>、<em>q</em> 這三個參數分別設為 1, 0, 0 後就可以正式開始訓練模型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 建立 ARIMA 模型物件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 此處使用的模型設定為 ARIMA(1,0,0)，這意味著AR(1)模型，沒有整合(I)和移動平均(MA)成分。</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> ARIMA(train, order<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用資料對模型進行擬合</span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示模型的摘要資訊</span>
</span></span><span style="display:flex;"><span>print(results<span style="color:#f92672">.</span>summary())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪製模型診斷圖，這可以幫助我們檢查模型擬合的品質</span>
</span></span><span style="display:flex;"><span>results<span style="color:#f92672">.</span>plot_diagnostics(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>))
</span></span></code></pre></div><pre tabindex="0"><code>                               SARIMAX Results
==============================================================================
Dep. Variable:                   PM25   No. Observations:                   72
Model:                 ARIMA(1, 0, 0)   Log Likelihood                -168.853
Date:                Fri, 26 Aug 2022   AIC                            343.706
Time:                        05:01:13   BIC                            350.536
Sample:                    06-17-2020   HQIC                           346.425
                         - 06-19-2020
Covariance Type:                  opg
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
const          6.3774      1.959      3.255      0.001       2.537      10.218
ar.L1          0.7792      0.047     16.584      0.000       0.687       0.871
sigma2         6.2934      0.746      8.438      0.000       4.832       7.755
===================================================================================
Ljung-Box (L1) (Q):                   0.08   Jarque-Bera (JB):                76.49
Prob(Q):                              0.77   Prob(JB):                         0.00
Heteroskedasticity (H):               2.30   Skew:                             1.44
Prob(H) (two-sided):                  0.05   Kurtosis:                         7.15
===================================================================================
</code></pre><p><img src="figures/4-2-3-2.png" alt="Python output"></p>
<p>接著我們使用測試資料進行預測，並評估其預測的效果，從圖形化的資料呈現中，我們可以發現資料預測結果的曲線太過平滑，和實際上的數值差異很大。事實上，若觀察整體資料的變化趨勢，會發現資料本身存在有規律的起伏，而 ARIMA 只能預測出資料的趨勢，若要準確的預測資料的數值，其結果仍有極大的差距。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用預先訓練的 ARIMA 模型，對指定時間範圍內的資料進行預測</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># start 和 end 參數確定了預測的時間範圍</span>
</span></span><span style="display:flex;"><span>data_arima[<span style="color:#e6db74">&#39;forecast&#39;</span>] <span style="color:#f92672">=</span> results<span style="color:#f92672">.</span>predict(start<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>, end<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 matplotlib 將真實的 PM2.5 值和預測值繪製在同一個圖上</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 這可以幫助我們直觀地看到模型的預測品質如何</span>
</span></span><span style="display:flex;"><span>data_arima[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>))
</span></span></code></pre></div><p><img src="figures/4-2-3-3.png" alt="Python output"></p>
<h3 id="sarimax">SARIMAX</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 從「2020-06-17」到「2020-06-21」選取 PM2.5 的資料</span>
</span></span><span style="display:flex;"><span>data_sarimax <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-17&#39;</span>:<span style="color:#e6db74">&#39;2020-06-21&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定訓練資料的長度為從開始到最後的 48 小時之前</span>
</span></span><span style="display:flex;"><span>train_len <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 iloc[] 擷取訓練資料集</span>
</span></span><span style="display:flex;"><span>train <span style="color:#f92672">=</span> data_sarimax<span style="color:#f92672">.</span>iloc[:train_len]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 iloc[] 擷取測試資料集</span>
</span></span><span style="display:flex;"><span>test <span style="color:#f92672">=</span> data_sarimax<span style="color:#f92672">.</span>iloc[train_len:]
</span></span></code></pre></div><p>我們接著介紹 SARIMAX 模型。SARIMAX 模型共有七個參數，分別是 <em>p</em>, <em>d</em>, <em>q</em>, <em>P</em>, <em>D</em>, <em>Q</em>, <em>s</em>；這些參數可以分為兩組：第一組為 <em>order=(p, d, q)</em> 這三個參數跟 ARIMA 模型的參數一樣；另一組是 <em>seasonal_order=(P, D, Q, s)</em>，也就是週期性的 AR 模型參數、週期性的差分次數、週期性的MA模型參數，最後再加上一個週期性長度的參數。</p>
<table>
<thead>
<tr>
<th>參數</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td>p</td>
<td>AR 模型參數</td>
</tr>
<tr>
<td>d</td>
<td>達到平穩性所需要的差分次數</td>
</tr>
<tr>
<td>q</td>
<td>MA 模型參數</td>
</tr>
<tr>
<td>P</td>
<td>週期性的 AR 模型參數</td>
</tr>
<tr>
<td>D</td>
<td>週期上達到平穩性所需要的差分次數</td>
</tr>
<tr>
<td>Q</td>
<td>週期性的 MA 模型參數</td>
</tr>
<tr>
<td>s</td>
<td>週期長度</td>
</tr>
</tbody>
</table>
<p>由於從先前的觀察可以發現，這些資料大致上約 24 個小時會有一個週期性的變化，因此我們讓 <code>s=24</code>，並用下列的指令進行模型建立。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 創建 SARIMAX 模型實例</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> SARIMAX(train, order<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>), seasonal_order<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">24</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 擬合模型到訓練資料</span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示模型摘要</span>
</span></span><span style="display:flex;"><span>print(results<span style="color:#f92672">.</span>summary())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪製模型的診斷圖</span>
</span></span><span style="display:flex;"><span>results<span style="color:#f92672">.</span>plot_diagnostics(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>))
</span></span></code></pre></div><pre tabindex="0"><code>                                     SARIMAX Results
==========================================================================================
Dep. Variable:                               PM25   No. Observations:                   72
Model:             SARIMAX(1, 0, 0)x(0, 1, 0, 24)   Log Likelihood                -121.463
Date:                            Fri, 26 Aug 2022   AIC                            246.926
Time:                                    05:01:26   BIC                            250.669
Sample:                                06-17-2020   HQIC                           248.341
                                     - 06-19-2020
Covariance Type:                              opg
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
ar.L1          0.6683      0.069      9.698      0.000       0.533       0.803
sigma2         9.1224      1.426      6.399      0.000       6.328      11.917
===================================================================================
Ljung-Box (L1) (Q):                   0.11   Jarque-Bera (JB):                 5.70
Prob(Q):                              0.75   Prob(JB):                         0.06
Heteroskedasticity (H):               2.03   Skew:                             0.42
Prob(H) (two-sided):                  0.17   Kurtosis:                         4.46
===================================================================================
</code></pre><p><img src="figures/4-2-3-4.png" alt="Python output"></p>
<p>接下來我們使用測試資料進行資料預測，並將預測結果用視覺化方式呈現，可以發現相較於 ARIMA 模型，SARIMA 模型的預測結果雖然仍有待加強，但已比 ARIMA 模型進步許多。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 總共有五天的資料，我們的目標是預測最後兩天的資料，這代表著48個小時的資料。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 起始小時為 24*5-48（也就是第三天的結束），結束小時為 24*5（第五天的結束）。</span>
</span></span><span style="display:flex;"><span>data_sarimax[<span style="color:#e6db74">&#39;forecast&#39;</span>] <span style="color:#f92672">=</span> results<span style="color:#f92672">.</span>predict(start<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>, end<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>data_sarimax[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>))
</span></span></code></pre></div><p><img src="figures/4-2-3-5.png" alt="Python output"></p>
<h3 id="auto_arima">auto_arima</h3>
<p>我們使用 <a href="https://pypi.org/project/pmdarima/">pmdarima</a> 這個 Python 套件，這個套件類似 R 語言中的 auto.arima 模型，可以自動尋找最合適的 ARIMA 模型參數，增加使用者在使用 ARIMA 模型時的方便性。目前 pmdarima 套件中的 pmdarima.ARIMA 物件，其實便同時包含了 ARMA, ARIMA 和 SARIMAX 這三種模型，而使用 pmdarima.auto_arima 方法時，只要提供參數 <em>p</em>, <em>q</em>, <em>P</em>, <em>Q</em> 的範圍，便能在指定的範圍內尋找出最適合的參數組合。</p>
<p>我們接下來實作 pmdarima.auto_arima 的使用方法，先把資料集切分為訓練資料與預測資料：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 從 air_hour 中選取 2020-06-17 到 2020-06-21 的資料</span>
</span></span><span style="display:flex;"><span>data_autoarima <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-17&#39;</span>:<span style="color:#e6db74">&#39;2020-06-21&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定要取出的測試資料長度，此處設為48（代表兩天的小時數）</span>
</span></span><span style="display:flex;"><span>train_len <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將資料分割為訓練資料和測試資料</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用 iloc 取出前面的資料作為訓練資料</span>
</span></span><span style="display:flex;"><span>train <span style="color:#f92672">=</span> data_autoarima<span style="color:#f92672">.</span>iloc[:train_len]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用 iloc 取出最後兩天的資料作為測試資料</span>
</span></span><span style="display:flex;"><span>test <span style="color:#f92672">=</span> data_autoarima<span style="color:#f92672">.</span>iloc[train_len:]
</span></span></code></pre></div><p>針對 <em>p</em>, <em>q</em>, <em>P</em>, <em>Q</em> 這四個參數，我們分別用 start 和 max 來指定對應的範圍，同時設定週期性參數 <em>seasonal</em> 為 <em>True</em>，並且設定週期變數 <em>m</em> 為 24 小時。接著我們便可以直接執行得到最佳的模型參數組合和模型擬合結果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用 auto_arima 函式自動找到最適合的 ARIMA 模型參數</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># train：輸入的訓練資料</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># start_p, d, start_q：開始測試的 p、d 和 q 值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># max_p, max_d, max_q：p、d 和 q 的最大值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># start_P, D, start_Q：季節性參數的起始值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># max_P, max_D, max_Q：季節性參數的最大值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># m=24：季節性週期，此處設定為24，因為我們的資料是每小時的，所以一天有24個小時</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># seasonal=True：考慮季節性</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># error_action=&#39;warn&#39;：如果出現錯誤，則發出警告</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># trace=True：追踪步驟，顯示過程</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># supress_warnings=True：壓制警告</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># stepwise=True：以步驟方式搜索模型參數，這通常會使搜索更快</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># random_state=20：確保結果的可重複性</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># n_fits=20：進行20次不同參數的擬合</span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">=</span> pm<span style="color:#f92672">.</span>auto_arima(train,start_p<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, d<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, start_q<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, max_p<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, max_d<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, max_q<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, start_P<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, D<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, start_Q<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, max_P<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, max_D<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, max_Q<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, m<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>, seasonal<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, error_action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;warn&#39;</span>, trace <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>, supress_warnings<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, stepwise <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, n_fits <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>print(results<span style="color:#f92672">.</span>summary())
</span></span></code></pre></div><pre tabindex="0"><code>Performing stepwise search to minimize aic
 ARIMA(0,0,0)(0,1,0)[24] intercept   : AIC=268.023, Time=0.04 sec
 ARIMA(1,0,0)(1,1,0)[24] intercept   : AIC=247.639, Time=0.85 sec
 ARIMA(0,0,1)(0,1,1)[24] intercept   : AIC=250.711, Time=0.79 sec
 ARIMA(0,0,0)(0,1,0)[24]             : AIC=271.305, Time=0.04 sec
 ARIMA(1,0,0)(0,1,0)[24] intercept   : AIC=247.106, Time=0.09 sec
 ARIMA(1,0,0)(0,1,1)[24] intercept   : AIC=247.668, Time=0.45 sec
 ARIMA(1,0,0)(1,1,1)[24] intercept   : AIC=inf, Time=2.63 sec
 ARIMA(2,0,0)(0,1,0)[24] intercept   : AIC=249.013, Time=0.15 sec
 ARIMA(1,0,1)(0,1,0)[24] intercept   : AIC=248.924, Time=0.21 sec
 ARIMA(0,0,1)(0,1,0)[24] intercept   : AIC=250.901, Time=0.11 sec
 ARIMA(2,0,1)(0,1,0)[24] intercept   : AIC=250.579, Time=0.30 sec
 ARIMA(1,0,0)(0,1,0)[24]             : AIC=246.926, Time=0.06 sec
 ARIMA(1,0,0)(1,1,0)[24]             : AIC=247.866, Time=0.28 sec
 ARIMA(1,0,0)(0,1,1)[24]             : AIC=247.933, Time=0.31 sec
 ARIMA(1,0,0)(1,1,1)[24]             : AIC=inf, Time=2.35 sec
 ARIMA(2,0,0)(0,1,0)[24]             : AIC=248.910, Time=0.08 sec
 ARIMA(1,0,1)(0,1,0)[24]             : AIC=248.893, Time=0.09 sec
 ARIMA(0,0,1)(0,1,0)[24]             : AIC=252.779, Time=0.08 sec
 ARIMA(2,0,1)(0,1,0)[24]             : AIC=250.561, Time=0.17 sec

Best model:  ARIMA(1,0,0)(0,1,0)[24]
Total fit time: 9.122 seconds
                                     SARIMAX Results
==========================================================================================
Dep. Variable:                                  y   No. Observations:                   72
Model:             SARIMAX(1, 0, 0)x(0, 1, 0, 24)   Log Likelihood                -121.463
Date:                            Fri, 26 Aug 2022   AIC                            246.926
Time:                                    05:01:37   BIC                            250.669
Sample:                                06-17-2020   HQIC                           248.341
                                     - 06-19-2020
Covariance Type:                              opg
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
ar.L1          0.6683      0.069      9.698      0.000       0.533       0.803
sigma2         9.1224      1.426      6.399      0.000       6.328      11.917
===================================================================================
Ljung-Box (L1) (Q):                   0.11   Jarque-Bera (JB):                 5.70
Prob(Q):                              0.75   Prob(JB):                         0.06
Heteroskedasticity (H):               2.03   Skew:                             0.42
Prob(H) (two-sided):                  0.17   Kurtosis:                         4.46
===================================================================================
</code></pre><p>最後我們使用尋找到的最佳模型進行資料預測，並且將預測結果與測試資料用疊圖的方式繪製在同一張圖上，由於本次所找到最佳模型即為剛剛介紹 SARIMAX 時的最佳模型參數組合，因此兩者的預測結果也大致相同。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用先前擬合的 ARIMA 模型進行預測</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># n_periods=10：預測接下來的 10 個時段（在這個例子中，即預測接下來的10個小時）</span>
</span></span><span style="display:flex;"><span>results<span style="color:#f92672">.</span>predict(n_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span></code></pre></div><pre tabindex="0"><code>2020-06-20 00:00:00    10.371336
2020-06-20 01:00:00    13.142043
2020-06-20 02:00:00    13.505843
2020-06-20 03:00:00     9.506395
2020-06-20 04:00:00     7.450378
2020-06-20 05:00:00     7.782850
2020-06-20 06:00:00     7.633757
2020-06-20 07:00:00     5.200781
2020-06-20 08:00:00     3.634188
2020-06-20 09:00:00     3.946824
Freq: H, dtype: float64
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用先前擬合的 ARIMA 模型進行預測</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># n_periods=48：預測接下來的 48 個時段</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將預測值新增到 data_autoarima DataFrame 的「forecast」列中</span>
</span></span><span style="display:flex;"><span>data_autoarima[<span style="color:#e6db74">&#39;forecast&#39;</span>]<span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(results<span style="color:#f92672">.</span>predict(n_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>), index<span style="color:#f92672">=</span>test<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在同一圖上繪製原始 PM2.5 資料和預測結果</span>
</span></span><span style="display:flex;"><span>data_autoarima[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>))
</span></span></code></pre></div><p><img src="figures/4-2-3-6.png" alt="Python output"></p>
<h3 id="prophet">Prophet</h3>
<p>我們接下來使用 kats 套件中提供的 <a href="https://facebook.github.io/prophet/">Prophet</a> 模型進行資料預測，這個模型是由 Facebook 的資料科學團隊提出，擅長針對週期性強的時間序列資料進行預測，並且可以容忍缺失資料 (missing data)、資料偏移 (shift) 以及偏離值 (outlier)。</p>
<p>我們首先把資料集切分為訓練資料與預測資料，並用折線圖的方式呈現訓練資料的變化狀況。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 從 air_hour 中選擇特定的日期區間</span>
</span></span><span style="display:flex;"><span>data_prophet <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-17&#39;</span>:<span style="color:#e6db74">&#39;2020-06-21&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定義訓練集和測試集的資料</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 由於我們要預測最後兩天，所以訓練集是從開始到倒數第二天，測試集則是最後兩天</span>
</span></span><span style="display:flex;"><span>train_len <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>train <span style="color:#f92672">=</span> data_prophet<span style="color:#f92672">.</span>iloc[:train_len]
</span></span><span style="display:flex;"><span>test <span style="color:#f92672">=</span> data_prophet<span style="color:#f92672">.</span>iloc[train_len:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將訓練資料轉換為 Kats 的 TimeSeriesData 物件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 這裡重置索引是因為 TimeSeriesData 需要時間作為一個欄位而不是索引</span>
</span></span><span style="display:flex;"><span>trainData <span style="color:#f92672">=</span> TimeSeriesData(train<span style="color:#f92672">.</span>reset_index(), time_col_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 TimeSeriesData 的 plot 函式繪製 PM2.5 的資料趨勢</span>
</span></span><span style="display:flex;"><span>trainData<span style="color:#f92672">.</span>plot(cols<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;PM25&#34;</span>])
</span></span></code></pre></div><p><img src="figures/4-2-3-7.png" alt="Python output"></p>
<p>我們接著使用 ProphetParams 設定 Prophet 模型的參數，並將訓練資料與參數用於初始化設定 ProphetModel，接著我們使用 fit 方法建立模型，並用 predict 方法進行資料預測，便能得到最後預測的結果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 指定模型參數，這裡選擇了乘性季節性模式</span>
</span></span><span style="display:flex;"><span>params <span style="color:#f92672">=</span> ProphetParams(seasonality_mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;multiplicative&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用訓練資料和上述參數，創建一個 Prophet 模型的實例</span>
</span></span><span style="display:flex;"><span>m <span style="color:#f92672">=</span> ProphetModel(trainData, params)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 擬合模型</span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>fit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 預測未來 48 小時的資料</span>
</span></span><span style="display:flex;"><span>fcst <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>predict(steps<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;H&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將預測結果加入到原始的 data_prophet 資料框中</span>
</span></span><span style="display:flex;"><span>data_prophet[<span style="color:#e6db74">&#39;forecast&#39;</span>] <span style="color:#f92672">=</span> fcst[[<span style="color:#e6db74">&#39;time&#39;</span>,<span style="color:#e6db74">&#39;fcst&#39;</span>]]<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最後顯示預測結果</span>
</span></span><span style="display:flex;"><span>fcst
</span></span></code></pre></div><pre tabindex="0"><code>                 time	    fcst	fcst_lower fcst_upper
0	2020-06-20 00:00:00	14.705192	12.268361	17.042476
1	2020-06-20 01:00:00	15.089580	12.625568	17.573396
2	2020-06-20 02:00:00	14.921077	12.459802	17.411335
3	2020-06-20 03:00:00	13.846131	11.444988	16.200284
4	2020-06-20 04:00:00	12.278140	9.863531	14.858334
5	2020-06-20 05:00:00	10.934739	8.372450	13.501025
6	2020-06-20 06:00:00	10.126712	7.654647	12.658054
7	2020-06-20 07:00:00	9.535067	7.034313	11.762639
8	2020-06-20 08:00:00	8.661877	6.255147	11.132732
9	2020-06-20 09:00:00	7.424133	5.055052	9.770750
10	2020-06-20 10:00:00	6.229786	3.640543	8.625856
11	2020-06-20 11:00:00	5.464764	3.039011	7.939283
12	2020-06-20 12:00:00	4.998005	2.692023	7.550191
13	2020-06-20 13:00:00	4.334771	1.961382	6.506875
14	2020-06-20 14:00:00	3.349172	1.059836	5.768178
15	2020-06-20 15:00:00	2.819902	0.399350	5.226658
16	2020-06-20 16:00:00	4.060070	1.556264	6.322976
17	2020-06-20 17:00:00	7.792830	5.331987	10.237182
18	2020-06-20 18:00:00	13.257767	10.873149	15.542380
19	2020-06-20 19:00:00	18.466805	15.895210	20.874602
20	2020-06-20 20:00:00	21.535994	19.150397	23.960260
21	2020-06-20 21:00:00	22.005943	19.509141	24.691836
22	2020-06-20 22:00:00	21.014449	18.610361	23.661906
23	2020-06-20 23:00:00	20.191905	17.600568	22.868388
24	2020-06-21 00:00:00	20.286952	17.734177	22.905280
25	2020-06-21 01:00:00	20.728067	18.235829	23.235212
26	2020-06-21 02:00:00	20.411124	17.755181	22.777073
27	2020-06-21 03:00:00	18.863739	16.261775	21.315573
28	2020-06-21 04:00:00	16.661351	13.905466	19.374726
29	2020-06-21 05:00:00	14.781150	12.401465	17.499478
30	2020-06-21 06:00:00	13.637436	11.206142	16.239831
31	2020-06-21 07:00:00	12.793609	9.940829	15.319559
32	2020-06-21 08:00:00	11.580455	9.059603	14.261605
33	2020-06-21 09:00:00	9.891025	7.230943	12.471543
34	2020-06-21 10:00:00	8.271552	5.840853	10.677227
35	2020-06-21 11:00:00	7.231671	4.829449	9.733231
36	2020-06-21 12:00:00	6.592515	4.108251	9.107216
37	2020-06-21 13:00:00	5.699548	3.288052	8.019402
38	2020-06-21 14:00:00	4.389985	1.848621	6.825121
39	2020-06-21 15:00:00	3.685033	1.196467	6.150064
40	2020-06-21 16:00:00	5.289956	2.907623	8.012851
41	2020-06-21 17:00:00	10.124029	7.397842	12.676256
42	2020-06-21 18:00:00	17.174959	14.670539	19.856592
43	2020-06-21 19:00:00	23.856724	21.102924	26.712359
44	2020-06-21 20:00:00	27.746195	24.636118	30.673178
45	2020-06-21 21:00:00	28.276321	25.175013	31.543197
46	2020-06-21 22:00:00	26.932054	23.690073	29.882014
47	2020-06-21 23:00:00	25.811943	22.960132	28.912079
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 顯示包括了原始的 PM2.5 值以及由 Prophet 模型所預測的值</span>
</span></span><span style="display:flex;"><span>data_prophet
</span></span></code></pre></div><pre tabindex="0"><code>          timestamp		  PM25	forecast
2020-06-17 00:00:00	6.300000	NaN
2020-06-17 01:00:00	11.444444	NaN
2020-06-17 02:00:00	6.777778	NaN
2020-06-17 03:00:00	4.875000	NaN
2020-06-17 04:00:00	5.444444	NaN
...	...	...
2020-06-21 19:00:00	18.777778	23.856724
2020-06-21 20:00:00	21.400000	27.746195
2020-06-21 21:00:00	11.222222	28.276321
2020-06-21 22:00:00	9.800000	26.932054
2020-06-21 23:00:00	8.100000	25.811943
</code></pre><p>我們接著使用 ProphetModel 內建的繪圖方法，將訓練資料 (黑線) 與預測結果 (藍線) 繪製出來。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 將原始的時間序列資料和模型的預測結果繪製在同一個圖上</span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>plot()
</span></span></code></pre></div><p><img src="figures/4-2-3-8.png" alt="Python output"></p>
<p>為了更容易觀察預測結果的正確性，我們使用另一種繪圖的方式，將訓練資料 (黑線)、測試資料 (黑線) 與預測結果 (藍線) 同時繪製出來，藍色曲線與同時間的黑色曲線在變化趨勢與數值區間皆十分相似，整體來說預測結果已可算是差強人意。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 創建一個 12x7 英吋的圖和軸物件</span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">7</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在同一個軸上繪製訓練資料，並標記為「train」，顏色設為黑色</span>
</span></span><span style="display:flex;"><span>train<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在同一個軸上繪製測試資料，顏色設為黑色</span>
</span></span><span style="display:flex;"><span>test<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在同一個軸上繪製預測值，顏色設為藍色</span>
</span></span><span style="display:flex;"><span>fcst<span style="color:#f92672">.</span>plot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;time&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fcst&#39;</span>, ax<span style="color:#f92672">=</span>ax, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪製預測值的信賴區間，使用藍色區域表示</span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>fill_between(test<span style="color:#f92672">.</span>index, fcst[<span style="color:#e6db74">&#39;fcst_lower&#39;</span>], fcst[<span style="color:#e6db74">&#39;fcst_upper&#39;</span>], alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除圖例，讓圖表看起來更乾淨</span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>get_legend()<span style="color:#f92672">.</span>remove()
</span></span></code></pre></div><p><img src="figures/4-2-3-9.png" alt="Python output"></p>
<h3 id="lstm">LSTM</h3>
<p>接下來，我們介紹使用 LSTM (long short-term memory) 模型進行資料預測。LSTM 模型是一種適合使用在連續資料的預測模型，因為它會對不同時間的資料產生不同的長短期記憶，並藉此預測出最後的結果。目前在 kats 套件中就有提供 LSTM 模型，因此我們可以直接用類似使用 Prophet 模型的語法進行操作。</p>
<p>我們首先把資料集切分為訓練資料與預測資料，並用繪圖的方式查看訓練資料的變化狀況。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 選取 2020 年 6 月 17 日至 6 月 21 日的小時資料</span>
</span></span><span style="display:flex;"><span>data_lstm <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-17&#39;</span>:<span style="color:#e6db74">&#39;2020-06-21&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定訓練資料的長度為最後兩天前的所有資料</span>
</span></span><span style="display:flex;"><span>train_len <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切割資料為訓練集和測試集</span>
</span></span><span style="display:flex;"><span>train <span style="color:#f92672">=</span> data_lstm<span style="color:#f92672">.</span>iloc[:train_len]
</span></span><span style="display:flex;"><span>test <span style="color:#f92672">=</span> data_lstm<span style="color:#f92672">.</span>iloc[train_len:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 Kats 的 TimeSeriesData 物件轉換訓練資料</span>
</span></span><span style="display:flex;"><span>trainData <span style="color:#f92672">=</span> TimeSeriesData(train<span style="color:#f92672">.</span>reset_index(), time_col_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 matplotlib 繪製訓練資料的 PM2.5 資料圖</span>
</span></span><span style="display:flex;"><span>trainData<span style="color:#f92672">.</span>plot(cols<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;PM25&#34;</span>])
</span></span></code></pre></div><p><img src="figures/4-2-3-10.png" alt="Python output"></p>
<p>接著我們依序選擇 LSTM 模型的各項參數，分別是訓練次數 (num_epochs)、一次讀入的資料時間長度 (time_window)、還有跟長短期記憶比較相關的神經網路層數 (hidden_size)，然後便可以直接進行模型訓練與資料預測。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 設定 LSTM 模型的參數</span>
</span></span><span style="display:flex;"><span>params <span style="color:#f92672">=</span> LSTMParams(
</span></span><span style="display:flex;"><span>    hidden_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, <span style="color:#75715e"># 隱藏層的大小</span>
</span></span><span style="display:flex;"><span>    time_window<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>, <span style="color:#75715e"># 時間窗格的大小</span>
</span></span><span style="display:flex;"><span>    num_epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#75715e"># 訓練時的迭代次數</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用上述參數建立一個 LSTM 模型實例</span>
</span></span><span style="display:flex;"><span>m <span style="color:#f92672">=</span> LSTMModel(trainData, params)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 對模型進行訓練</span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>fit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用模型進行預測，預測接下來的 48 小時</span>
</span></span><span style="display:flex;"><span>fcst <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>predict(steps<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;H&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將預測結果添加到 data_lstm 資料框中</span>
</span></span><span style="display:flex;"><span>data_lstm[<span style="color:#e6db74">&#39;forecast&#39;</span>] <span style="color:#f92672">=</span> fcst[[<span style="color:#e6db74">&#39;time&#39;</span>, <span style="color:#e6db74">&#39;fcst&#39;</span>]]<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示預測結果</span>
</span></span><span style="display:flex;"><span>fcst
</span></span></code></pre></div><pre tabindex="0"><code>                 time	    fcst	fcst_lower	fcst_upper
0	2020-06-20 00:00:00	11.905971	11.310672	12.501269
1	2020-06-20 01:00:00	10.804338	10.264121	11.344554
2	2020-06-20 02:00:00	9.740741	9.253704	10.227778
3	2020-06-20 03:00:00	8.696406	8.261586	9.131226
4	2020-06-20 04:00:00	7.656923	7.274077	8.039769
5	2020-06-20 05:00:00	6.608442	6.278019	6.938864
6	2020-06-20 06:00:00	5.543790	5.266600	5.820979
7	2020-06-20 07:00:00	4.469023	4.245572	4.692474
8	2020-06-20 08:00:00	3.408312	3.237897	3.578728
9	2020-06-20 09:00:00	2.411980	2.291381	2.532578
10	2020-06-20 10:00:00	1.564808	1.486567	1.643048
11	2020-06-20 11:00:00	0.982147	0.933040	1.031255
12	2020-06-20 12:00:00	0.792612	0.752981	0.832242
13	2020-06-20 13:00:00	1.105420	1.050149	1.160691
14	2020-06-20 14:00:00	1.979013	1.880062	2.077964
15	2020-06-20 15:00:00	3.408440	3.238018	3.578862
16	2020-06-20 16:00:00	5.337892	5.070997	5.604786
17	2020-06-20 17:00:00	7.659332	7.276365	8.042299
18	2020-06-20 18:00:00	10.104147	9.598940	10.609355
19	2020-06-20 19:00:00	12.047168	11.444809	12.649526
20	2020-06-20 20:00:00	12.880240	12.236228	13.524252
21	2020-06-20 21:00:00	12.748750	12.111312	13.386187
22	2020-06-20 22:00:00	12.128366	11.521947	12.734784
23	2020-06-20 23:00:00	11.311866	10.746273	11.877459
24	2020-06-21 00:00:00	10.419082	9.898128	10.940036
25	2020-06-21 01:00:00	9.494399	9.019679	9.969119
26	2020-06-21 02:00:00	8.551890	8.124296	8.979485
27	2020-06-21 03:00:00	7.592260	7.212647	7.971873
28	2020-06-21 04:00:00	6.613075	6.282421	6.943729
29	2020-06-21 05:00:00	5.614669	5.333936	5.895402
30	2020-06-21 06:00:00	4.605963	4.375664	4.836261
31	2020-06-21 07:00:00	3.611552	3.430974	3.792129
32	2020-06-21 08:00:00	2.679572	2.545593	2.813550
33	2020-06-21 09:00:00	1.887442	1.793070	1.981814
34	2020-06-21 10:00:00	1.340268	1.273255	1.407282
35	2020-06-21 11:00:00	1.156494	1.098669	1.214318
36	2020-06-21 12:00:00	1.440240	1.368228	1.512252
37	2020-06-21 13:00:00	2.251431	2.138859	2.364002
38	2020-06-21 14:00:00	3.592712	3.413076	3.772347
39	2020-06-21 15:00:00	5.415959	5.145161	5.686757
40	2020-06-21 16:00:00	7.613187	7.232528	7.993847
41	2020-06-21 17:00:00	9.918564	9.422636	10.414493
42	2020-06-21 18:00:00	11.755348	11.167580	12.343115
43	2020-06-21 19:00:00	12.576593	11.947764	13.205423
44	2020-06-21 20:00:00	12.489052	11.864599	13.113504
45	2020-06-21 21:00:00	11.915885	11.320090	12.511679
46	2020-06-21 22:00:00	11.133274	10.576610	11.689938
47	2020-06-21 23:00:00	10.264495	9.751270	10.777719
</code></pre><p>我們一樣使用 LSTMModel 內建的繪圖方法，將訓練資料 (黑線) 與預測結果 (藍線) 繪製出來。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>m<span style="color:#f92672">.</span>plot()
</span></span></code></pre></div><p><img src="figures/4-2-3-11.png" alt="Python output"></p>
<p>為了觀察預測結果的正確性，我們也使用另一種繪圖的方式，將訓練資料 (黑線)、測試資料 (黑線) 與預測結果 (藍線) 同時繪製出來，從圖中可以觀察到藍色曲線與同時間的黑色曲線在變化趨勢上大致一致，但整體來說資料預測的結果 (藍線) 則比實際測試資料  (黑線) 的數值略低一些。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 創建一個 12x7 大小的圖形和對應的座標軸</span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">7</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在圖形上畫出訓練資料，並標記為&#39;train&#39;，使用黑色表示</span>
</span></span><span style="display:flex;"><span>train<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在圖形上畫出測試資料，使用黑色表示</span>
</span></span><span style="display:flex;"><span>test<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在圖形上畫出預測資料，使用藍色表示</span>
</span></span><span style="display:flex;"><span>fcst<span style="color:#f92672">.</span>plot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;time&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fcst&#39;</span>, ax<span style="color:#f92672">=</span>ax, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 填充預測結果的上下界範圍，使用透明度為 0.1 的區域表示不確定性範圍</span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>fill_between(test<span style="color:#f92672">.</span>index, fcst[<span style="color:#e6db74">&#39;fcst_lower&#39;</span>], fcst[<span style="color:#e6db74">&#39;fcst_upper&#39;</span>], alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除圖例</span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>get_legend()<span style="color:#f92672">.</span>remove()
</span></span></code></pre></div><p><img src="figures/4-2-3-12.png" alt="Python output"></p>
<h3 id="holt-winter">Holt-Winter</h3>
<p>我們也使用 kats 套件提供的 Holt-Winter 模型，這是一種利用移動平均的概念，分配歷史資料的權重，以進行資料預測的方法。我們一樣先把資料集切分為訓練資料與預測資料，並用繪圖的方式查看訓練資料的變化狀況。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 選擇「2020-06-17」到「2020-06-21」期間的資料</span>
</span></span><span style="display:flex;"><span>data_hw <span style="color:#f92672">=</span> air_hour<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2020-06-17&#39;</span>:<span style="color:#e6db74">&#39;2020-06-21&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定測試資料的長度為48筆</span>
</span></span><span style="display:flex;"><span>train_len <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切分訓練資料和測試資料</span>
</span></span><span style="display:flex;"><span>train <span style="color:#f92672">=</span> data_hw<span style="color:#f92672">.</span>iloc[:train_len]
</span></span><span style="display:flex;"><span>test <span style="color:#f92672">=</span> data_hw<span style="color:#f92672">.</span>iloc[train_len:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將訓練資料轉換成 Kats 的 TimeSeriesData 格式</span>
</span></span><span style="display:flex;"><span>trainData <span style="color:#f92672">=</span> TimeSeriesData(train<span style="color:#f92672">.</span>reset_index(), time_col_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;timestamp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 matplotlib 繪製訓練資料的 PM25 時間序列圖</span>
</span></span><span style="display:flex;"><span>trainData<span style="color:#f92672">.</span>plot(cols<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;PM25&#34;</span>])
</span></span></code></pre></div><p><img src="figures/4-2-3-13.png" alt="Python output"></p>
<p>接著我們需要設定 Holt-Winter 模型的參數，分別是設定使用加法或乘法來分解時序資料 (以下範例使用乘法 mul)，以及週期性的長度 (以下範例設為 24 小時)，然後便可以進行模型訓練與資料預測。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 忽略所有警告，使輸出更加乾淨</span>
</span></span><span style="display:flex;"><span>warnings<span style="color:#f92672">.</span>simplefilter(action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ignore&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定 Holt-Winters 模型的參數：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 趨勢 (trend) 使用乘法方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 季節性 (seasonal) 也使用乘法方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 季節性週期 (seasonal_periods) 設定為 24，代表一天的小時數。</span>
</span></span><span style="display:flex;"><span>params <span style="color:#f92672">=</span> HoltWintersParams(
</span></span><span style="display:flex;"><span>            trend<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mul&#34;</span>,
</span></span><span style="display:flex;"><span>            seasonal<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mul&#34;</span>,
</span></span><span style="display:flex;"><span>            seasonal_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 建立 Holt-Winters 時序模型的實例。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 輸入包括先前定義的資料集和參數。</span>
</span></span><span style="display:flex;"><span>m <span style="color:#f92672">=</span> HoltWintersModel(
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">=</span>trainData, 
</span></span><span style="display:flex;"><span>    params<span style="color:#f92672">=</span>params)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用訓練資料集擬合模型</span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>fit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 預測未來48小時的資料</span>
</span></span><span style="display:flex;"><span>fcst <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>predict(steps<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;H&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 將預測結果添加到原始的資料框中</span>
</span></span><span style="display:flex;"><span>data_hw[<span style="color:#e6db74">&#39;forecast&#39;</span>] <span style="color:#f92672">=</span> fcst[[<span style="color:#e6db74">&#39;time&#39;</span>, <span style="color:#e6db74">&#39;fcst&#39;</span>]]<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示預測結果</span>
</span></span><span style="display:flex;"><span>fcst
</span></span></code></pre></div><pre tabindex="0"><code>                   time	    fcst
72	2020-06-20 00:00:00	14.140232
73	2020-06-20 01:00:00	14.571588
74	2020-06-20 02:00:00	12.797056
75	2020-06-20 03:00:00	10.061594
76	2020-06-20 04:00:00	9.927476
77	2020-06-20 05:00:00	8.732691
78	2020-06-20 06:00:00	10.257460
79	2020-06-20 07:00:00	8.169070
80	2020-06-20 08:00:00	6.005400
81	2020-06-20 09:00:00	5.038056
82	2020-06-20 10:00:00	6.391835
83	2020-06-20 11:00:00	5.435677
84	2020-06-20 12:00:00	3.536135
85	2020-06-20 13:00:00	2.725477
86	2020-06-20 14:00:00	2.588198
87	2020-06-20 15:00:00	2.967987
88	2020-06-20 16:00:00	3.329448
89	2020-06-20 17:00:00	4.409821
90	2020-06-20 18:00:00	10.295263
91	2020-06-20 19:00:00	10.587033
92	2020-06-20 20:00:00	14.061718
93	2020-06-20 21:00:00	18.597275
94	2020-06-20 22:00:00	12.040684
95	2020-06-20 23:00:00	12.124081
96	2020-06-21 00:00:00	13.522973
97	2020-06-21 01:00:00	13.935499
98	2020-06-21 02:00:00	12.238431
99	2020-06-21 03:00:00	9.622379
100	2020-06-21 04:00:00	9.494116
101	2020-06-21 05:00:00	8.351486
102	2020-06-21 06:00:00	9.809694
103	2020-06-21 07:00:00	7.812468
104	2020-06-21 08:00:00	5.743248
105	2020-06-21 09:00:00	4.818132
106	2020-06-21 10:00:00	6.112815
107	2020-06-21 11:00:00	5.198396
108	2020-06-21 12:00:00	3.381773
109	2020-06-21 13:00:00	2.606503
110	2020-06-21 14:00:00	2.475216
111	2020-06-21 15:00:00	2.838426
112	2020-06-21 16:00:00	3.184109
113	2020-06-21 17:00:00	4.217320
114	2020-06-21 18:00:00	9.845847
115	2020-06-21 19:00:00	10.124881
116	2020-06-21 20:00:00	13.447887
117	2020-06-21 21:00:00	17.785455
118	2020-06-21 22:00:00	11.515076
119	2020-06-21 23:00:00	11.594832
</code></pre><p>我們一樣使用 HoltWintersModel 內建的繪圖方法，將訓練資料 (黑線) 與預測結果 (藍線) 繪製出來。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 使用模型的 plot() 方法來繪製原始資料、預測值和預測的信賴區間</span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>plot()
</span></span></code></pre></div><p><img src="figures/4-2-3-14.png" alt="Python output"></p>
<p>為了觀察預測結果的正確性，我們也使用另一種繪圖的方式，將訓練資料 (黑線)、測試資料 (黑線) 與預測結果 (藍線) 同時繪製出來，從圖中可以觀察到藍色曲線與同時間的黑色曲線在變化趨勢與數值區間皆大致一致，但整體來說資料預測的結果 (藍線) 對於上升坡段的反應略慢於測試資料 (黑線)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 創建一個 12x7 的圖形和座標軸</span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">7</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪製訓練資料，以黑色線表示</span>
</span></span><span style="display:flex;"><span>train<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪製測試資料，也是以黑色線表示</span>
</span></span><span style="display:flex;"><span>test<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪製預測結果，使用藍色線</span>
</span></span><span style="display:flex;"><span>fcst<span style="color:#f92672">.</span>plot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;time&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fcst&#39;</span>, ax<span style="color:#f92672">=</span>ax, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 填充預測的信賴區間，使用淡藍色</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ax.fill_between(test.index, fcst[&#39;fcst_lower&#39;], fcst[&#39;fcst_upper&#39;], alpha=0.1)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 移除圖例</span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>get_legend()<span style="color:#f92672">.</span>remove()
</span></span></code></pre></div><p><img src="figures/4-2-3-15.png" alt="Python output"></p>
<h3 id="綜合比較">綜合比較</h3>
<p>最後，為了方便觀察與比較起見，我們將剛剛介紹的六種預測模型的預測結果，同時繪製在下方的圖中（註：要先跑過上面所有預測模型的程式碼才看得到六張圖），可以清楚地觀察與比較六種模型在不同時間區間與曲線變化特性下的預測準確度，方便使用者決定最終的模型選擇，以及未來的可能應用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 創建一個 3x2 的子圖，整體圖的大小為 12x8</span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(nrows<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在第 1 行第 1 列的子圖中，繪製 ARIMA 的真實資料和預測資料</span>
</span></span><span style="display:flex;"><span>data_arima[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>axes[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ARIMA&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在第 2 行第 1 列的子圖中，繪製 SARIMAX 的真實資料和預測資料</span>
</span></span><span style="display:flex;"><span>data_sarimax[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>axes[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>], title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;SARIMAX&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在第 3 行第 1 列的子圖中，繪製 auto_arima 的真實資料和預測資料</span>
</span></span><span style="display:flex;"><span>data_autoarima[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>axes[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>], title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;auto_arima&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在第 1 行第 2 列的子圖中，繪製 Prophet 的真實資料和預測資料</span>
</span></span><span style="display:flex;"><span>data_prophet[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>axes[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>], title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Prophet&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在第 2 行第 2 列的子圖中，繪製 LSTM 的真實資料和預測資料</span>
</span></span><span style="display:flex;"><span>data_lstm[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>axes[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>], title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;LSTM&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在第 3 行第 2 列的子圖中，繪製 Holt-Winter 的真實資料和預測資料</span>
</span></span><span style="display:flex;"><span>data_hw[[<span style="color:#e6db74">&#39;PM25&#39;</span>, <span style="color:#e6db74">&#39;forecast&#39;</span>]]<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>axes[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>], title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Holt-Winter&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 調整子圖的間距，使子圖不會重疊</span>
</span></span><span style="display:flex;"><span>fig<span style="color:#f92672">.</span>tight_layout(pad<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, w_pad<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, h_pad<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span></code></pre></div><p><img src="figures/4-2-3-16.png" alt="Python output"></p>
<h2 id="參考資料">參考資料</h2>
<ul>
<li>民生公共物聯網歷史資料 (<a href="https://history.colife.org.tw/#/">https://history.colife.org.tw/</a>)</li>
<li>Rob J Hyndman and George Athanasopoulos, Forecasting: Principles and Practice, 3rd edition (<a href="https://otexts.com/fpp3/">https://otexts.com/fpp3/</a>)</li>
<li>Stationarity, NIST Engineering Statistics Handbook (<a href="https://www.itl.nist.gov/div898/handbook/pmc/section4/pmc442.htm">https://www.itl.nist.gov/div898/handbook/pmc/section4/pmc442.htm</a>)</li>
<li>Unit root test - Wikipedia (<a href="https://en.wikipedia.org/wiki/Unit_root_test">https://en.wikipedia.org/wiki/Unit_root_test</a>)</li>
<li>Akaike information criterion (AIC) - Wikipedia (<a href="https://en.wikipedia.org/wiki/Akaike_information_criterion">https://en.wikipedia.org/wiki/Akaike_information_criterion</a>)</li>
<li>Bayesian information criterion (BIC) - Wikipedia (<a href="https://en.wikipedia.org/wiki/Bayesian_information_criterion">https://en.wikipedia.org/wiki/Bayesian_information_criterion</a>)</li>
<li>ARIMA models (<a href="https://otexts.com/fpp2/arima.html">https://otexts.com/fpp2/arima.html</a>)</li>
<li>SARIMAX: Introduction (<a href="https://www.statsmodels.org/stable/examples/notebooks/generated/statespace_sarimax_stata.html">https://www.statsmodels.org/stable/examples/notebooks/generated/statespace_sarimax_stata.html</a>)</li>
<li>Prophet: Forecasting at scale (<a href="https://facebook.github.io/prophet/">https://facebook.github.io/prophet/</a>)</li>
<li>Long short-term memory (LSTM) – Wikipedia (<a href="https://en.wikipedia.org/wiki/Long_short-term_memory">https://en.wikipedia.org/wiki/Long_short-term_memory</a>)</li>
<li>Time Series Forecasting with ARIMA Models In Python [Part 1] | by Youssef Hosni | May, 2022 | Towards AI (<a href="https://pub.towardsai.net/time-series-forecasting-with-arima-models-in-python-part-1-c2940a7dbc48?gi=264dc7630363">https://pub.towardsai.net/time-series-forecasting-with-arima-models-in-python-part-1-c2940a7dbc48?gi=264dc7630363</a>)</li>
<li>Time Series Forecasting with ARIMA Models In Python [Part 2] | by Youssef Hosni | May, 2022 | Towards AI (<a href="https://pub.towardsai.net/time-series-forecasting-with-arima-models-in-python-part-2-91a30d10efb0">https://pub.towardsai.net/time-series-forecasting-with-arima-models-in-python-part-2-91a30d10efb0</a>)</li>
<li>Kats: a Generalizable Framework to Analyze Time Series Data in Python | by Khuyen Tran | Towards Data Science (<a href="https://towardsdatascience.com/kats-a-generalizable-framework-to-analyze-time-series-data-in-python-3c8d21efe057">https://towardsdatascience.com/kats-a-generalizable-framework-to-analyze-time-series-data-in-python-3c8d21efe057</a>)</li>
<li>Kats - Time Series Forecasting By Facebook | by Himanshu Sharma | MLearning.ai | Medium (<a href="https://medium.com/mlearning-ai/kats-time-series-forecasting-by-facebook-a2741794d814">https://medium.com/mlearning-ai/kats-time-series-forecasting-by-facebook-a2741794d814</a>)</li>
</ul>

            <footer class="footline">
            </footer>
          </article>


<div align="center">
<hr width="70%">

This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 Unported License</a>.
<br />
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0;margin:2px" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
</div>
<p style="height:30px">

<div id="disqus_thread" style="border-style: ridge; padding-inline:5px"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'learnciot';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        </div>
      </main>
    </div>
    <aside id="sidebar" class="default-animation showVisitedLinks">
      <div id="header-wrapper" class="default-animation">
        <div id="header" class="default-animation">
          <style>
            #logo svg,
            #logo svg * {
              color: #282828;
              color: var(--MENU-SECTIONS-BG-color);
              fill: #282828 !important;
              fill: var(--MENU-SECTIONS-BG-color) !important;
              opacity: .945;
            }
            a#logo {
              color: #282828;
              color: var(--MENU-SECTIONS-BG-color);
              font-family: 'Work Sans', 'Helvetica', 'Tahoma', 'Geneva', 'Arial', sans-serif;
              font-size: 30px;
              font-weight: 300;
              margin-top: -13px;
              max-width: 60%;
              text-transform: uppercase;
              width: 226px;
              white-space: nowrap;
            }
            a#logo:hover {
              color: #282828;
              color: var(--MENU-SECTIONS-BG-color);
            }
            #logo svg {
              margin-bottom: -20px;
              margin-left: -23.5px;
              width: 40.5%;
            }
            @media only all and (max-width: 59.938em) {
              a#logo {
                font-size: 25px;
                margin-top: -3px;
              }
              #logo svg {
                margin-bottom: -12px;
                margin-left: -23px;
              }
            }
            @media all and (-ms-high-contrast:none) {
              /* IE11s understanding of positioning is weird at best */
              a#logo {
                margin-top: -58px;
              }
              #logo svg {
                margin-bottom: -62px;
              }
            }
          </style>
          <a id="logo" href="/">
            Learn CIoT
          </a>

        </div>
        <div class="searchbox default-animation">
          <label class="a11y-only" for="search-by">搜尋</label>
          <i class="fas fa-search"></i>
          <input data-search-input id="search-by" type="search" placeholder="搜尋...">
          <span data-search-clear=""><i class="fas fa-times"></i></span>
        </div>
        <script>
          var contentLangs=['zh'];
        </script>
        <script src="/js/auto-complete.js?1701306709" defer></script>
        <script src="/js/lunr.min.js?1701306709" defer></script>
        <script src="/js/lunr.stemmer.support.min.js?1701306709" defer></script>
        <script src="/js/lunr.multi.min.js?1701306709" defer></script>
        <script src="/js/lunr.zh.min.js?1701306709" defer></script>
        <script src="/js/search.js?1701306709" defer></script>
      </div>
      <div id="content-wrapper" class="highlightable">
        <ul class="topics">
          <li data-nav-id="/ch1/" title="1. 教學網站簡介" class="dd-item"><a href="/ch1/">1. 教學網站簡介<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch2/" title="2. 整體課程前言" class="dd-item"><label for="section-0c4ff77f81b29c69f37066d67544c3b9" ></label><a href="/ch2/">2. 整體課程前言<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/ch2/ch2.1/" title="2.1. 課程架構說明" class="dd-item"><a href="/ch2/ch2.1/">2.1. 課程架構說明<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch2/ch2.2/" title="2.2. 課程軟體工具簡介" class="dd-item"><a href="/ch2/ch2.2/">2.2. 課程軟體工具簡介<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/ch3/" title="3. 資料取用" class="dd-item"><label for="section-2d571a52f8e6e09b8c11625532edb2d4" ></label><a href="/ch3/">3. 資料取用<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/ch3/ch3.1/" title="3.1. 基本資料存取方法" class="dd-item"><a href="/ch3/ch3.1/">3.1. 基本資料存取方法<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch3/ch3.2/" title="3.2. 存取特定時空條件的資料" class="dd-item"><a href="/ch3/ch3.2/">3.2. 存取特定時空條件的資料<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/ch4/" title="4. 時間維度資料分析" class="dd-item parent"><label for="section-a3965432c40ae592eaa5a4a04592685e" ></label><a href="/ch4/">4. 時間維度資料分析<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/ch4/ch4.1/" title="4.1. 時間序列資料處理" class="dd-item"><a href="/ch4/ch4.1/">4.1. 時間序列資料處理<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch4/ch4.2/" title="4.2. 時間序列資料預測" class="dd-item active"><a href="/ch4/ch4.2/">4.2. 時間序列資料預測<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch4/ch4.3/" title="4.3. 時間序列屬性分群" class="dd-item"><a href="/ch4/ch4.3/">4.3. 時間序列屬性分群<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/ch5/" title="5. 空間維度資料分析" class="dd-item"><label for="section-b6a8e999e0329c5971871ffc5b34192f" ></label><a href="/ch5/">5. 空間維度資料分析<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/ch5/ch5.1/" title="5.1. 地理空間篩選" class="dd-item"><a href="/ch5/ch5.1/">5.1. 地理空間篩選<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch5/ch5.2/" title="5.2. 地理空間分析" class="dd-item"><a href="/ch5/ch5.2/">5.2. 地理空間分析<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/ch6/" title="6. 資料應用" class="dd-item"><label for="section-f8bc2d76b61c5c9922024382e3ab1dcb" ></label><a href="/ch6/">6. 資料應用<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/ch6/ch6.1/" title="6.1. 機器學習初探" class="dd-item"><a href="/ch6/ch6.1/">6.1. 機器學習初探<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch6/ch6.2/" title="6.2. 異常資料偵測" class="dd-item"><a href="/ch6/ch6.2/">6.2. 異常資料偵測<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch6/ch6.3/" title="6.3. 感測器聯合校正" class="dd-item"><a href="/ch6/ch6.3/">6.3. 感測器聯合校正<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/ch7/" title="7. 系統整合應用" class="dd-item"><label for="section-c663021a728355d88e45618764e92f92" ></label><a href="/ch7/">7. 系統整合應用<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/ch7/ch7.1/" title="7.1. QGIS 應用" class="dd-item"><a href="/ch7/ch7.1/">7.1. QGIS 應用<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch7/ch7.2/" title="7.2. Tableau 應用" class="dd-item"><a href="/ch7/ch7.2/">7.2. Tableau 應用<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/ch7/ch7.3/" title="7.3 Leafmap 應用" class="dd-item"><a href="/ch7/ch7.3/">7.3 Leafmap 應用<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/video/" title="教學影片" class="dd-item"><a href="/video/">教學影片<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/about/" title="關於我們" class="dd-item"><a href="/about/">關於我們<i class="fas fa-check read-icon"></i></a></li>
        </ul>
        <div id="shortcuts">
          <div class="nav-title">其他連結</div>
          <ul>
            <li><a class="padding" href="https://github.com/LearnCIOT/LearnCIOT.github.io"><i class='fab fa-fw fa-github'></i> GitHub</a></li>
            <li><a class="padding" href="/levels/"><i class='fas fa-fw fa-heartbeat'></i> 按照難度等級查詢</a></li>
            <li><a class="padding" href="/tags/"><i class='fas fa-fw fa-tags'></i> 按照文章標籤查詢</a></li>
            <li><a class="padding" href="/authors/"><i class='fas fa-fw fa-users'></i> 按照文章作者查詢</a></li>
          </ul>
        </div>
        <div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showLangSwitch showVisitedLinks showFooter"></div>
        <hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showLangSwitch showVisitedLinks showFooter"/>
        <div id="prefooter" class="footerLangSwitch footerVariantSwitch footerVisitedLinks showLangSwitch showVisitedLinks">
          <ul>
            <li id="select-language-container" class="footerLangSwitch showLangSwitch">
              <a class="padding select-container">
                <i class="fas fa-language fa-fw"></i>
                <span>&nbsp;</span>
                <div class="select-style">
                  <select id="select-language" onchange="location = baseUri + this.value;">
                    <option id="en" value="/en/ch4/ch4.2/">English</option>
                    <option id="zh-tw" value="/ch4/ch4.2/" selected>中文</option>
                  </select>
                </div>
                <div class="select-clear"></div>
              </a>
            </li>
            <li id="select-variant-container" class="footerVariantSwitch">
              <a class="padding select-container">
                <i class="fas fa-paint-brush fa-fw"></i>
                <span>&nbsp;</span>
                <div class="select-style">
                  <select id="select-variant" onchange="window.variants && variants.changeVariant( this.value );">
                    <option id="relearn-light" value="relearn-light" selected>Relearn Light</option>
                  </select>
                </div>
                <div class="select-clear"></div>
              </a>
              <script>window.variants && variants.markSelectedVariant();</script>
            </li>
            <li class="footerVisitedLinks showVisitedLinks"><a class="padding" onclick="clearHistory();"><i class="fas fa-history fa-fw"></i> 清除歷史紀錄</a></li>
          </ul>
        </div>
        <div id="footer" class="footerFooter showFooter">
	    <p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p>
        </div>
      </div>
    </aside>

    <script src="/js/clipboard.min.js?1701306709" defer></script>
    <script src="/js/perfect-scrollbar.min.js?1701306709" defer></script>
    <script src="/js/featherlight.min.js?1701306709" defer></script>
    <script src="/js/jquery.svg.pan.zoom.js?1701306709" defer></script>
    <script src="/js/mermaid.min.js?1701306709" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{}");
    </script>
    <script src="/js/theme.js?1701306709" defer></script>
  </body>
</html>
